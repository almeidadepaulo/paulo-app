-- Configura Procedure
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- Apaga Procedure
IF  EXISTS (SELECT * FROM sys.objects WHERE object_id = OBJECT_ID(N'[dbo].[SP_BN401_CALCULA_EXIGIBILIDADE]') AND type in (N'P', N'PC'))
DROP PROCEDURE  [dbo].[SP_BN401_CALCULA_EXIGIBILIDADE]
GO

-- Cria Procedure
CREATE PROCEDURE [dbo].[SP_BN401_CALCULA_EXIGIBILIDADE]
/*:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
  :: EMPRESA    : IMSTECH                                                      ::
  :: SISTEMA    : DPGE2                                                        ::
  :: MÓDULO     : Calcula Exigibilidade                                        ::
  :: OBSERVAÇÃO : Gera tabelas 												   ::
  ::				BN401 - Resumo de Garantias	(Acrescenta dia	seguinte)	   ::
  :: 				BN208 - Controle de Limite por Faixa (Gerada)			   ::
  :: 				BN214 - Bordero da Base Consolidada por Contrato (Gerada)  ::
  :: 				BN215 - Bordero de Base Consol.Entidade/Empresa (Gerada)   ::
  ::																		   ::
  ::---------------------------------------------------------------------------::
  :: PROGRAMADOR:                                                              ::
  :: DATA       :                                              VERSÃO SP:      ::
  :: ALTERAÇÃO  :                                                              ::
  ::---------------------------------------------------------------------------::
  :: PROGRAMADOR: Fábio Bernardo                                               ::
  :: DATA       : 17/10/2013												   ::
  :: ALTERAÇÃO  : Exigibilidade por contrato BN214		                       ::
  ::			  Resumo por Entidade/Empresa BN215							   ::
  ::---------------------------------------------------------------------------::
  :: PROGRAMADOR: Fábio Bernardo                                               ::
  :: DATA       : 24/06/2013												   ::
  :: ALTERAÇÃO  : Nova coluna 7 - Devolução por Aditamento                     ::
  :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::*/
  /*-------------------------------------------------------------------------------
  DESCRIÇÃO DA FUNCIONALIDADE:

  Parametros de Entrada
  -------------------------------------------------------------------------------*/
  --@ENT_NR_VRS    VARCHAR(4)           /* ENTRADA DA VERSAO DO MODULO             */
  WITH ENCRYPTION
AS
SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS OFF


SET NOCOUNT ON

-- VARIAVEIS DO CURSOR
DECLARE  @VOLTA_LE_PARCELA		INT
		,@BN403_NR_GRUPO		NUMERIC(8)
		,@BN403_NR_INST			NUMERIC(8)
		,@BN403_NR_CONTRA		char(40)
		,@BN403_DT_VENCTO		NUMERIC(8)
		,@BN403_NR_CONTA		NUMERIC(12)
		,@BN403_VL_VALOR		NUMERIC(17,2)
		,@BN405_NR_PROD			NUMERIC(8)
		,@BN004_TP_PROD			CHAR(1)
		,@BN405_QT_PARC			NUMERIC(8)
		,@BN405_TX_FINAM		NUMERIC(10,5)
		,@BN004_NR_VOL48		NUMERIC(10,5)
		,@BN004_NR_VOL60		NUMERIC(10,5)

-- TOTALIZADORES DO BORDERO DE CONTRATO
		,@BN214_NR_GRUPO		NUMERIC(8) 
		,@BN214_NR_INST			NUMERIC(8) 
		,@BN214_NR_PROD			NUMERIC(8) 
		,@BN214_NR_CONTRA		CHAR(40)   
		,@BN214_TT_NOM			NUMERIC(17,2) = 0
		,@BN214_TT_PRES			NUMERIC(17,2) = 0
		,@BN214_TT_EXIG			NUMERIC(17,2) = 0
		
		
-- VARIAVEIS DE CALCULO
		,@DT_AMANHA				DATE
		,@NR_AMANHA				NUMERIC(8) = 0
		,@DT_DIF				DATE
		,@NR_DIF				NUMERIC(8) = 0
 		,@NR_DIAS				NUMERIC(7) = 0
		,@TAXA					NUMERIC(30,8)		-- 03 WS-TAXA COMP-2. -- DE 7 P/ 8 - 2 CENTAVOS A MENOS
 		,@PRAZO					NUMERIC(20,7) 
 		,@TAXA_PERIODO			NUMERIC(15,8) = 0	-- 03 WS-TAXA-PER  PIC 9(003)V9(10) COMP-3.
 		,@VL_PRES				NUMERIC(10,2) = 0
 		,@VL_EXIG				NUMERIC(10,2) = 0
 		,@NR_EXIG				NUMERIC(3)
 		,@TAXA_EXIG				NUMERIC(15,5) = 0
		,@VL_VENC				NUMERIC(10,2) = 0
		,@VL_VENC15				NUMERIC(10,2) = 0
		,@NR_FAIXA				NUMERIC(1) = 0
		,@ERRO1					VARCHAR(200)


-- PEGA DATA DE AMANHA
SELECT TOP 1 @NR_AMANHA  = BN005_DT_AMANHA FROM BN005 ORDER BY BN005_NR_ORDEM DESC 

--SET @NR_AMANHA  = 20131017 -- *** COMENTAR ESTA LINHA POIS ESTA FORÇANDO A DATA ?? ***


SET @DT_AMANHA	= CAST(CAST(@NR_AMANHA  AS CHAR(8)) AS DATE)  

-- CALCULA 15 DIAS 
SET @DT_DIF		= DATEADD(DD,15,@DT_AMANHA)
SET @NR_DIF		= CONVERT(CHAR(8),@DT_DIF,112)


SET @ERRO1 ='EXIGIBILIDADE JA CALCULADA NA DATA DE AMANHA ('+
				CONVERT(VARCHAR(10),@DT_AMANHA,111)+')'
				
				
--COMENTAR ABAIXO PARA TESTE ??
IF EXISTS (SELECT TOP 1 BN401_DT_MOVTO FROM BN401 WHERE BN401_DT_MOVTO = @NR_AMANHA  ) 
BEGIN
   RAISERROR (@ERRO1,10,1) 
   RETURN 
END       





-- TOTALIZADOR RESUMO GARANTIA
DECLARE @BN401 TABLE (
	 BN401_NR_GRUPO		numeric(8)
	,BN401_NR_INST		numeric(8)
	,BN401_NR_PROD		numeric(5)
	,BN401_TT_GAR		numeric(17,2)
	,BN401_TT_PRES		numeric(17,2)
	,BN401_TT_EXIG		numeric(17,2)
	,BN401_TT_VENC		numeric(17,2)
	,BN401_TT_VENC15	numeric(17,2)
	,PRIMARY KEY (BN401_NR_GRUPO, BN401_NR_INST, BN401_NR_PROD)
)

INSERT INTO @BN401 
SELECT  DISTINCT 
	 BN405_NR_GRUPO	
	,BN405_NR_INST	
	,BN405_NR_PROD	
	,0.00	-- BN401_TT_GAR			numeric(17,2)
	,0.00	-- BN401_TT_PRES		numeric(17,2)
	,0.00	-- BN401_TT_EXIG		numeric(17,2)
	,0.00	-- BN401_TT_VENC		numeric(17,2)
	,0.00	-- BN401_TT_VENC15		numeric(17,2)
FROM BN405







-- TOTALIZADOR LIMITE POR FAIXA
DECLARE @BN208 TABLE (
	 BN208_NR_GRUPO		numeric(8)
	,BN208_NR_INST		numeric(8)
	,BN208_NR_FAIXA		numeric(1)
	,BN208_TT_EXIG		numeric(17,2)
	,PRIMARY KEY (BN208_NR_GRUPO, BN208_NR_INST, BN208_NR_FAIXA)
)
-- CRIA FAIXAS

INSERT INTO @BN208 -- FAIXA 1
SELECT  DISTINCT BN405_NR_GRUPO, BN405_NR_INST, 1, 0.00	FROM BN405

INSERT INTO @BN208 -- FAIXA 2
SELECT  DISTINCT BN405_NR_GRUPO, BN405_NR_INST, 2, 0.00	FROM BN405

INSERT INTO @BN208 -- FAIXA 3
SELECT  DISTINCT BN405_NR_GRUPO, BN405_NR_INST, 3, 0.00	FROM BN405

INSERT INTO @BN208 -- FAIXA 4
SELECT  DISTINCT BN405_NR_GRUPO, BN405_NR_INST, 4, 0.00	FROM BN405

INSERT INTO @BN208 -- FAIXA 5
SELECT  DISTINCT BN405_NR_GRUPO, BN405_NR_INST, 5, 0.00	FROM BN405

INSERT INTO @BN208 -- FAIXA 6
SELECT  DISTINCT BN405_NR_GRUPO, BN405_NR_INST, 6, 0.00	FROM BN405





-- EXIGIBILIDADE POR ENTIDADE
DECLARE @BN413 TABLE (
	 BN413_NR_CNPJ	numeric(14)
	,BN413_NR_PROD	numeric(5)
	,BN413_NR_EXIG	numeric(3)
	,PRIMARY KEY (BN413_NR_CNPJ,BN413_NR_PROD)
)

INSERT INTO @BN413
SELECT 
	 BN413_NR_CNPJ
	,BN413_NR_PROD
	,BN413_NR_EXIG
FROM BN413









-- GERA REGISTRO DO BORDERO DOS CONTRATOS
TRUNCATE TABLE BN214
INSERT INTO BN214
SELECT 
	 BN403_NR_GRUPO			-- BN214_NR_GRUPO
	,BN403_NR_INST			-- BN214_NR_INST
	,BN004_NR_PROD			-- BN214_NR_PROD
	,BN403_NR_CONTRA		-- BN214_NR_CONTRA
	,BN405_NR_LOTE			-- BN214_NR_LOTE
	,BN403_NR_BANCO			-- BN214_NR_BANCO
	,BN403_NR_AGENC			-- BN214_NR_AGENC
	,BN403_NR_CONTA			-- BN214_NR_CONTA
	,BN405_TP_CPFCNPJ		-- BN214_TP_CPFCNPJ
	,BN405_NR_CPFCNPJ		-- BN214_NR_CPFCNPJ
	,BN403_VL_VALOR			-- BN214_VL_PARC
	,BN405_TX_FINAM			-- BN214_TX_FINANC
	,COUNT(*)				-- BN214_QT_PAREX
	,MIN(BN403_DT_VENCTO)	-- BN214_DT_PVCTO
	,MAX(BN403_DT_VENCTO)	-- BN214_DT_UVCTO
	,0						-- BN214_TT_NOM
	,0						-- BN214_TT_PRES
	,0						-- BN214_TT_EXIG
	,0						-- BN214_NR_OPESIS
	,GETDATE()				-- BN214_DT_INCSIS
	,GETDATE()				-- BN214_DT_ATUSIS
	
FROM BN403 WITH (NOLOCK) -- PARCELAS

INNER JOIN BN405 WITH (NOLOCK) -- CONTRATOS
ON		BN405_NR_GRUPO	= BN403_NR_GRUPO
AND		BN405_NR_INST	= BN403_NR_INST
AND		BN405_NR_CONTRA	= BN403_NR_CONTRA

LEFT JOIN BN004 AS BN004 -- PRODUTO  (% EXIGIBILIDADE)
ON BN004_NR_PROD = BN405_NR_PROD

WHERE   
	BN403_ST_PAGTO  <> 1
	--AND	BN405_NR_PROD=2 -- USADO PARA TESTE RAPIDO ??
GROUP BY 
	 BN403_NR_GRUPO			
	,BN403_NR_INST			
	,BN004_NR_PROD			
	,BN403_NR_CONTRA		
	,BN405_NR_LOTE			
	,BN403_NR_BANCO			
	,BN403_NR_AGENC			
	,BN403_NR_CONTA			
	,BN405_TP_CPFCNPJ		
	,BN405_NR_CPFCNPJ		
	,BN403_VL_VALOR			
	,BN405_TX_FINAM			
		


-- ZERA TOTALIZADORES DO CONTRATO
SET @BN214_NR_CONTRA = '?' -- FORÇA VERIFICAÇÃO NA 1A. VEZ
SET @BN214_TT_NOM	 = 0
SET @BN214_TT_PRES	 = 0
SET @BN214_TT_EXIG	 = 0














--PRINT '@DT_AMANHA. = '+CAST(@DT_AMANHA		AS VARCHAR(100))
--PRINT '@NR_AMANHA. = '+CAST(@NR_AMANHA		AS VARCHAR(100))
--PRINT '@DT_DIF.... = '+CAST(@DT_DIF			AS VARCHAR(100))
--PRINT '@NR_DIF.... = '+CAST(@NR_DIF			AS VARCHAR(100))
--PRINT ' '

-- LE TODAS AS PACELAS COM O CONTRATO
DECLARE LE_PARCELA CURSOR READ_ONLY FOR 
SELECT
	 BN403_NR_GRUPO
	,BN403_NR_INST
	,BN403_NR_CONTRA
	,BN403_DT_VENCTO
	,BN403_NR_CONTA
	,BN403_VL_VALOR
	,BN405_NR_PROD
	,BN004_TP_PROD
	,BN004_NR_VOL48
	,BN004_NR_VOL60
	,BN405_QT_PARC
	,BN405_TX_FINAM
FROM BN403 WITH (NOLOCK) -- PARCELAS
INNER JOIN BN405 WITH (NOLOCK) -- CONTRATOS
ON		BN405_NR_GRUPO	= BN403_NR_GRUPO
AND		BN405_NR_INST	= BN403_NR_INST
AND		BN405_NR_CONTRA	= BN403_NR_CONTRA

LEFT JOIN BN004 AS BN004 -- PRODUTO  (% EXIGIBILIDADE)
ON BN004_NR_PROD = BN405_NR_PROD

WHERE   
	BN403_ST_PAGTO  <> 1
	
	--AND	BN405_QT_PARC >50
	--AND	BN413_NR_EXIG IS NOT NULL

	--AND	BN405_NR_PROD=11 -- USADO PARA TESTE RAPIDO ??
	--AND	BN405_NR_PROD=2 -- USADO PARA TESTE RAPIDO ??
	
ORDER BY 
	 BN403_NR_GRUPO
	,BN403_NR_INST
	,BN403_NR_CONTRA
	,BN403_DT_VENCTO



OPEN	LE_PARCELA
SET		@VOLTA_LE_PARCELA = 0
WHILE	@VOLTA_LE_PARCELA = 0
BEGIN
  FETCH NEXT FROM LE_PARCELA  INTO
	 @BN403_NR_GRUPO
	,@BN403_NR_INST
	,@BN403_NR_CONTRA
	,@BN403_DT_VENCTO
	,@BN403_NR_CONTA
	,@BN403_VL_VALOR
	,@BN405_NR_PROD
	,@BN004_TP_PROD
	,@BN004_NR_VOL48
	,@BN004_NR_VOL60	
	,@BN405_QT_PARC
	,@BN405_TX_FINAM
	


	-- GRAVA BORDERO DO CONTRATO
	IF	   @BN214_NR_GRUPO	<> @BN403_NR_GRUPO 
		OR @BN214_NR_INST	<> @BN403_NR_INST
		OR @BN214_NR_PROD	<> @BN405_NR_PROD
		OR @BN214_NR_CONTRA <> @BN403_NR_CONTRA
		OR @@FETCH_STATUS <> 0 -- FORÇAR GRAVAR O ÚLTIMO CONTRATO APOS TERMINAR O CURSOR
	BEGIN

		IF @BN214_NR_CONTRA <> '?' 
		BEGIN
			UPDATE BN214 SET 
				 BN214_TT_NOM	= @BN214_TT_NOM
				,BN214_TT_PRES	= @BN214_TT_PRES
				,BN214_TT_EXIG	= @BN214_TT_EXIG
			WHERE	BN214_NR_GRUPO	= @BN214_NR_GRUPO 
				AND	BN214_NR_INST	= @BN214_NR_INST
				AND	BN214_NR_PROD   = @BN214_NR_PROD
				AND	BN214_NR_CONTRA	= @BN214_NR_CONTRA

			-- ZERA TOTALIZADORES DO CONTRATO
			SET @BN214_NR_CONTRA = '?' -- FORÇA VERIFICAÇÃO NA 1A. VEZ
			SET @BN214_TT_NOM	 = 0
			SET @BN214_TT_PRES	 = 0
			SET @BN214_TT_EXIG	 = 0
		END -- ATUALIZA CONTRATO
		
		SET @BN214_NR_GRUPO		= @BN403_NR_GRUPO 
		SET	@BN214_NR_INST		= @BN403_NR_INST
		SET	@BN214_NR_PROD		= @BN405_NR_PROD
		SET	@BN214_NR_CONTRA	= @BN403_NR_CONTRA
		    			
	END -- FIM DO TOTALIZADOR 
	
			    

				
	
	IF @@FETCH_STATUS <>0 SET @VOLTA_LE_PARCELA=1
    IF @VOLTA_LE_PARCELA = 0 
    BEGIN    
    
   		-- SE FOR CONSIGNADO TENTA PEGAR DA ENTIDADE
		IF   @BN004_TP_PROD = 'C' BEGIN

			SET @NR_EXIG = 
				(
					SELECT ISNULL(BN413_NR_EXIG,0) FROM @BN413 -- ENTIDADE (% EXIGIBILIDADE)
					WHERE  BN413_NR_CNPJ		= @BN403_NR_CONTA 
						   AND BN413_NR_PROD	= @BN405_NR_PROD
				)
			
			IF @NR_EXIG <> 0 BEGIN
				SET @BN004_NR_VOL48 = @NR_EXIG
				SET @BN004_NR_VOL60 = @NR_EXIG
			END 
		END -- PRODUTO CONSIGNADO


		SET @VL_PRES	 = 0
		SET @VL_EXIG	 = 0
		SET @VL_VENC	 = 0
		SET @VL_VENC15	 = 0

		-- SE ESTIVER EM ATRASO NÃO PRECISA TRAZER A VALOR PRESENTE
		IF  @BN403_DT_VENCTO <= @NR_AMANHA	SET @VL_VENC = @BN403_VL_VALOR
		ELSE BEGIN
			--PRINT 'SIM'

			-- CALCULA NUMERO DE DIAS ATÉ O VENCTO (POSITIVO)
			SET @NR_DIAS = DATEDIFF(DD,@DT_AMANHA, CAST(@BN403_DT_VENCTO AS CHAR(8))) 

			-- ACHA FATOR DE MULTIPLICAÇÃO DA TAXA
			SET @TAXA = (@BN405_TX_FINAM/100)+1
			
			-- CALCULA PRAZO EM MESES
			SET @PRAZO = (@NR_DIAS/30)

			-- TAXA DO PERIODO = TAXA DO CONTRATO EXPONENCIAL A QUANTIDADE DE DIAS DO PRAZO FUTURO 			
			SET @TAXA_PERIODO = POWER(@TAXA,@PRAZO)

			-- CALCULA VALOR PRESENTE E TRUNCA C/ 2 CASAS DECIMAIS			
			SET @VL_PRES = ROUND(@BN403_VL_VALOR/@TAXA_PERIODO, 2, 1) 
		
			-- CALCULA EXIGIBILIDADE	
			IF  @BN405_QT_PARC < 49		SET @TAXA_EXIG= @BN004_NR_VOL48/100
			ELSE						SET @TAXA_EXIG= @BN004_NR_VOL60/100
			SET @VL_EXIG = ROUND(@VL_PRES / @TAXA_EXIG,2,1)

			-- CALCULA VENCIMENTO ANTES DE 15 DIAS			
			IF @BN403_DT_VENCTO <= @NR_DIF  SET @VL_VENC15 = @VL_EXIG


			-- TOTALIZADORES POR FAIXA DE VENCIMENTO
			IF @NR_DIAS <= 190					SET @NR_FAIXA = 1
			IF @NR_DIAS BETWEEN 191 AND 365		SET @NR_FAIXA = 2
			IF @NR_DIAS BETWEEN 366 AND 545		SET @NR_FAIXA = 3
			IF @NR_DIAS BETWEEN 546 AND 725		SET @NR_FAIXA = 4
			IF @NR_DIAS BETWEEN 726 AND 905		SET @NR_FAIXA = 5
			IF @NR_DIAS > 905					SET @NR_FAIXA = 6
	    
			-- SOMA TOTALIZADOR DA FAIXA
			UPDATE @BN208 SET BN208_TT_EXIG += @VL_EXIG 
  			   WHERE	BN208_NR_GRUPO	= @BN403_NR_GRUPO 
  					AND	BN208_NR_INST	= @BN403_NR_INST
  					AND	BN208_NR_FAIXA	= @NR_FAIXA
		END -- FIM DO CALCULO

/*
PRINT '@DT_AMANHA....... = '+CAST(@DT_AMANHA				AS VARCHAR(100))
PRINT '@BN403_DT_VENCTO. = '+CAST(@BN403_DT_VENCTO			AS VARCHAR(100))
PRINT '@NR_DIAS......... = '+CAST(@NR_DIAS					AS VARCHAR(100))

PRINT '@TAXA_PERIODO.. = '+CAST(@TAXA_PERIODO			AS VARCHAR(100))
PRINT '@BN403_VL_VALOR = '+CAST(@BN403_VL_VALOR		AS VARCHAR(100))
PRINT '@VL_PRES = '+CAST(@VL_PRES			AS VARCHAR(100))
PRINT '@TT_PRES = '+CAST(@TT_PRES			AS VARCHAR(100))


PRINT '@BN405_QT_PARC... = '+CAST(@BN405_QT_PARC			AS VARCHAR(100))
PRINT '@BN004_NR_VOL48.. = '+CAST(@BN004_NR_VOL48			AS VARCHAR(100))
PRINT '@BN004_NR_VOL60.. = '+CAST(@BN004_NR_VOL60			AS VARCHAR(100))
PRINT '@TAXA_EXIG....... = '+CAST(@TAXA_EXIG			AS VARCHAR(100))

PRINT ' '

--SET @VOLTA_LE_PARCELA=1 -- PARAR APOS O PRIMEIRO CALCULO
	
					)
*/


		-- SOMAR TOTALIZADORES				
		UPDATE @BN401 SET 
			 BN401_TT_GAR		+= @BN403_VL_VALOR
			,BN401_TT_PRES		+= @VL_PRES
			,BN401_TT_EXIG		+= @VL_EXIG
			,BN401_TT_VENC		+= @VL_VENC
			,BN401_TT_VENC15	+= @VL_VENC15
		WHERE	BN401_NR_GRUPO = @BN403_NR_GRUPO 
			AND	BN401_NR_INST  = @BN403_NR_INST
			AND	BN401_NR_PROD  = @BN405_NR_PROD  
			
			
		-- SOMAR TOTALIZADORES DO BORDERO DO CONTRATO
			SET @BN214_TT_NOM	+= @BN403_VL_VALOR
			SET @BN214_TT_PRES	+= @VL_PRES
			SET @BN214_TT_EXIG	+= @VL_EXIG
		    
    END -- END LEITURA
END
CLOSE LE_PARCELA
DEALLOCATE LE_PARCELA	
	

-- APAGA TOTALIZAR ZERADO
DELETE FROM @BN401 WHERE BN401_TT_GAR = 0

--DELETE FROM BN401 WHERE BN401_DT_MOVTO = 9999 -- DELETE PARA TESTE ??


INSERT INTO BN401 
(
	 BN401_NR_GRUPO
	,BN401_NR_INST
	,BN401_DT_MOVTO
	,BN401_NR_PROD
	,BN401_TT_GAR
	,BN401_TT_PRES
	,BN401_TT_EXIG
	,BN401_TT_VENC
	,BN401_TT_VENC15
	,BN401_NR_OPESIS
	,BN401_DT_INCSIS
	,BN401_DT_ATUSIS
)
SELECT 
	 BN401_NR_GRUPO 
	,BN401_NR_INST
	,@NR_AMANHA -- DATA DE MOVTO 
--	,9999 -- PARA TESTE -- COMENTAR ALINHA ACIMA @NR_AMANHA DATA DE MOVTO  ??
	,BN401_NR_PROD  
	,BN401_TT_GAR	
	,BN401_TT_PRES	
	,BN401_TT_EXIG	
	,BN401_TT_VENC	
	,BN401_TT_VENC15
	,0
	,GETDATE()
	,GETDATE()
FROM @BN401





DELETE FROM BN208
INSERT INTO BN208
SELECT 
	 BN208_NR_GRUPO		-- BN208_NR_GRUPO
	,BN208_NR_INST		-- BN208_NR_INST
	,BN208_NR_FAIXA		-- BN208_NR_FAIXA
	,BN208_TT_EXIG		-- BN208_TT_LIMCON36
	,0					-- BN208_TT_LIMCON24
	,0 					-- BN208_TT_LIMCON
	,0 					-- BN208_TT_DPGEFS1
	,0					-- BN208_TT_DPGEFS2
	,0					-- BN208_TT_LIMDSP
	,0 					-- BN208_TT_SDFAIXA
	,0 					-- BN208_TT_AUXILIAR
	,0 					-- BN208_TT_AJUSTE
	,0 					-- BN208_NR_OPESIS
	,GETDATE()			-- BN208_DT_INCSIS
	,GETDATE()			-- BN208_DT_ATUSIS
FROM @BN208
	


-- GERA BORDERO POR ENTIDADE/EMPRESA
TRUNCATE TABLE BN215
INSERT INTO BN215
SELECT 
	 BN214_NR_GRUPO		-- BN215_NR_GRUPO
	,BN214_NR_INST		-- BN215_NR_INST
	,BN214_NR_PROD		-- BN215_NR_PROD
	,BN214_NR_BANCO		-- BN215_NR_BANCO
	,BN214_NR_AGENC		-- BN215_NR_AGENC
	,BN214_NR_CONTA		-- BN215_NR_CONTA
	,0					-- BN215_NR_CNPJ
	,COUNT(*)			-- BN215_TT_CONTRA
	,SUM(BN214_TT_NOM)	-- BN215_TT_NOM
	,SUM(BN214_TT_PRES)	-- BN215_TT_PRES
	,SUM(BN214_TT_EXIG)	-- BN215_TT_EXIG
	,0					-- BN215_NR_OPESIS
	,GETDATE()			-- BN215_DT_INCSIS
	,GETDATE()			-- BN215_DT_ATUSIS
FROM BN214
GROUP BY 
	 BN214_NR_GRUPO	
	,BN214_NR_INST	
	,BN214_NR_PROD	
	,BN214_NR_BANCO	
	,BN214_NR_AGENC	
	,BN214_NR_CONTA	


--SELECT * FROM @BN208


/*

SELECT * FROM BN401 WITH (NOLOCK) WHERE BN401_DT_MOVTO = 9999  -- 04:25
SELECT * FROM BN401 WHERE BN401_DT_MOVTO = 999


SELECT * FROM BN401 ORDER BY BN401_DT_INCSIS DESC

SELECT * FROM BN005 ORDER BY BN005_DT_HOJE DESC
	


WHERE BN403_ST_PAGTO  <> 1	
GROUP BY 
	 BN403_NR_GRUPO
	,BN403_NR_INST
	,BN405_NR_PROD



	
INSERT INTO @BN401 ( BN401_NR_GRUPO	,BN401_NR_INST	,BN401_NR_PROD		
					,BN401_TT_GAR	,BN401_TT_PRES	,BN401_TT_EXIG	,BN401_TT_VENC	,BN401_TT_VENC15 )


SELECT				@BN403_NR_GRUPO	,@BN403_NR_INST	,@BN405_NR_PROD		
					 ,0				,0				,0				,0				,0
WHERE	NOT EXISTS ( SELECT BN401_NR_GRUPO FROM @BN401
					 WHERE	BN401_NR_GRUPO	= @BN403_NR_GRUPO 
						AND	BN401_NR_INST	= @BN403_NR_INST
						AND	BN401_NR_PROD	= @BN405_NR_PROD 

INICIO 05:38 - 338 SEGUNDOS
	   03:48 - 228 SEGUNDOS
	
*/	






SET QUOTED_IDENTIFIER OFF
SET ANSI_NULLS ON
/*-------------------------------------------------------------------------------
  SAIDA:
-------------------------------------------------------------------------------*/

GO
