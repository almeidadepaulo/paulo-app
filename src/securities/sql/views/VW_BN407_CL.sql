-- Configura View
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- Apaga view
IF  EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[VW_BN407_CL]'))
DROP VIEW [dbo].[VW_BN407_CL]
GO

-- Tela Controle de Limite
-- Cria View
CREATE VIEW [dbo].[VW_BN407_CL]
WITH ENCRYPTION
AS
 SELECT *
 ,TT_DISPONIVEL = 
 	CASE
    	WHEN TT_EXIGIDO > VL_LIMCON THEN (VL_LIMCON - TT_CAPTACAO)
        ELSE (TT_EXIGIDO - TT_CAPTACAO)
    END

 ,TT_PORC_EXIGIDO = 
 	CASE 
	 	WHEN TT_EXIGIDO <=0 THEN 0
		ELSE ((TT_EXIGIDO - TT_CAPTACAO) / TT_EXIGIDO)*100
    END
 ,TT_PORC_LIMITE  = CONVERT
 	(
 		NUMERIC(17,2),
	 	CASE 
		 	WHEN TT_EXIGIDO <=0 THEN 0
			ELSE (TT_CAPTACAO/TT_EXIGIDO)*100
	    END 
    )
 FROM 
(
 SELECT 

  BN002.BN002_NR_GRUPO,
  BN002.BN002_NR_INST,
  BN002.BN002_NM_INST,
  
  BN001.BN001_NR_GRUPO,
  BN001.BN001_NM_GRUPO,


	
-- TRAZ LIMITE CONCEDIDO
  ISNULL ((
    SELECT 
    BN407.BN407_VL_LIMCON
    FROM
    BN407 AS BN407
    WHERE	BN407.BN407_NR_INST  = BN002.BN002_NR_INST  AND
   			BN407.BN407_NR_GRUPO = BN002.BN002_NR_GRUPO 
  ),0) AS VL_LIMCON,
  
  -- TRAZ STATUS LIMITE CONCEDIDO
  ISNULL ((
    SELECT 
    BN407.BN407_ST_LIM
    FROM
    BN407 AS BN407
    WHERE	BN407.BN407_NR_INST		= BN002.BN002_NR_INST AND
   			BN407.BN407_NR_GRUPO 	= BN002.BN002_NR_GRUPO 

  ),0) AS BN407_ST_LIM,


-- SOMA TOTAL DE CAPTAÇÕES 
  ISNULL ((
    SELECT 
    SUM (BN410.BN410_VL_ATUAL)
    FROM
    BN410 AS BN410
    WHERE	BN410.BN410_NR_INST		= BN002.BN002_NR_INST AND
			BN410.BN410_NR_GRUPO	= BN002.BN002_NR_GRUPO AND
            BN410.BN410_ST_DPG2 	= 'S'
  ),0) 
  +
  ISNULL ((
    SELECT 
    SUM (BN406.BN406_VL_FINEMI)
    FROM
    BN406 AS BN406
    WHERE	BN406.BN406_NR_INST		= BN002.BN002_NR_INST AND
			BN406.BN406_NR_GRUPO 	= BN002.BN002_NR_GRUPO AND
    	    BN406.BN406_ST_APROV 	= 'A'
  ),0) AS TT_CAPTACAO,
  
  
  
-- SOMA TOTAL DAS GARANTIAS 
  ISNULL ((
    SELECT 
    SUM(BN401.BN401_TT_PRES) 
    FROM
    BN401 AS BN401
    WHERE BN401.BN401_NR_INST 	= BN002.BN002_NR_INST AND
    	  BN401.BN401_NR_GRUPO 	= BN002.BN002_NR_GRUPO AND
	      BN401.BN401_DT_MOVTO 	= (SELECT MAX(BN401.BN401_DT_MOVTO) FROM BN401 WHERE BN401.BN401_NR_INST=BN002.BN002_NR_INST)
  ),0) AS  TT_GARANTIA,
   
   ISNULL ((
    SELECT 
    SUM(BN401.BN401_TT_EXIG) 
    FROM
    BN401 AS BN401
    WHERE BN401.BN401_NR_INST 	= BN002.BN002_NR_INST AND
    	  BN401.BN401_NR_GRUPO 	= BN002.BN002_NR_GRUPO AND
	      BN401.BN401_DT_MOVTO 	= (SELECT MAX(BN401.BN401_DT_MOVTO) FROM BN401 WHERE BN401.BN401_NR_INST=BN002.BN002_NR_INST)
  ),0) AS  TT_EXIGIDO


  -- CAMPOS PARA PREVISÃO DE GARANTIA

	-- Recupera Prévia de novos lotes VP
	,ISNULL ((
	SELECT 
		BN407.BN407_VL_PREVNL
	FROM
		BN407 AS BN407
	WHERE	BN407.BN407_NR_INST  = BN002.BN002_NR_INST  AND
   			BN407.BN407_NR_GRUPO = BN002.BN002_NR_GRUPO 
	),0) AS PNL

	-- Recupera Prévia de baixas VP
	,ISNULL ((
	SELECT 
		BN407.BN407_VL_PREVBX
	FROM
		BN407 AS BN407
	WHERE	BN407.BN407_NR_INST  = BN002.BN002_NR_INST  AND
   			BN407.BN407_NR_GRUPO = BN002.BN002_NR_GRUPO 
	),0) AS PDB

	-- Recupera Fluxo de vencimentos (Semana)
	,ISNULL ((
	SELECT 
		BN407.BN407_VL_FLVCTS
	FROM
		BN407 AS BN407
	WHERE	BN407.BN407_NR_INST  = BN002.BN002_NR_INST  AND
   			BN407.BN407_NR_GRUPO = BN002.BN002_NR_GRUPO 
	),0) AS FVS

	-- Recupera Fluxo de vencimentos (Semana)
	,ISNULL ((
	SELECT 
		BN407.BN407_VL_FLVCTQ
	FROM
		BN407 AS BN407
	WHERE	BN407.BN407_NR_INST  = BN002.BN002_NR_INST  AND
   			BN407.BN407_NR_GRUPO = BN002.BN002_NR_GRUPO 
	),0) AS FVQ

	--TÍTULOS PÚBLICOS BLOQUEADOS
	,ISNULL ((
	SELECT
		SUM(BN216_VL_UNIT*BN216_QT_UNIT)
	FROM
		BN216 AS BN216
	WHERE
		BN216.BN216_NR_GRUPO  = BN002.BN002_NR_GRUPO 
	AND BN216.BN216_NR_INST   = BN002.BN002_NR_INST
	AND BN216.BN216_TP_STATUS = 'B'
	),0) AS LFT_LTN_BLOQUEADO


  FROM BN002 AS BN002
  
  INNER JOIN BN001 AS BN001
  ON BN002.BN002_NR_GRUPO = BN001.BN001_NR_GRUPO
) CB_TOTAL

--  INNER JOIN BN408 AS BN408
--  ON  BN408.BN408_NR_GRUPO = BN407.BN407_NR_GRUPO
--  AND BN408.BN408_NR_INST  = BN407.BN407_NR_INST



GO


