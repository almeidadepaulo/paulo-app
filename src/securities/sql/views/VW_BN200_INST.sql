-- Configura View
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- Apaga view
IF  EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[VW_BN200_INST]'))
DROP VIEW [dbo].[VW_BN200_INST]
GO

-- Cria View
/*
Recupera todas as intistuições quem possui vínculo com a empresa
*/
CREATE VIEW [dbo].[VW_BN200_INST]
WITH ENCRYPTION
AS
       	
	SELECT	
		BN200.BN200_NR_GRUPO
		,BN200.BN200_NR_INST
		,BN200.BN200_NR_CNPJ

		/*
		,BN200.BN200_LT_RATCALCBC
		,BN200.BN200_LT_RISKSCOR
		,BN200.BN200_QT_QTDEIF
		,BN200.BN200_NM_EEMCCB*/
		
		,BN002.BN002_NM_INST
		
		-- QUANTIDADE DE IF QUE A EMPRESA POSSUI OPERAÇÕES NO SISTEMA DO DPGE
		,ISNULL(
			(
			SELECT COUNT(*)
			FROM 
			(
				SELECT	
						BN200_NR_GRUPO
						,BN200_NR_INST
				FROM	BN200
				WHERE	BN200_NR_CNPJ	= BN200_NR_CNPJ
				GROUP BY
						BN200_NR_GRUPO
						,BN200_NR_INST
			) as subquery

		),0)	AS BN200_QT_QTDEIFFGC
		
		-- TOTAL DE CONTRATOS QUE A EMPRESA POSSUI ATIVOS (STATUS LIBERADO E PRÉVIA DESBLOQUEIO)
		,ISNULL(
			(
				SELECT	COUNT(BN201_VL_TCONTRA) 
				FROM	BN201
				WHERE
					BN201_NR_GRUPO	= BN200.BN200_NR_GRUPO
				AND BN201_NR_INST	= BN200.BN200_NR_INST
				AND BN201_NR_CNPJ	= BN200.BN200_NR_CNPJ
				AND BN201_ST_CONTRATO IN('L','P')
			),0
		)	AS BN200_QT_CONTRA_ATIVO
		
		-- VALOR TOTAL DOS CONTRATOS QUE A EMPRESA POSSUI ATIVOS (STATUS LIBERADO E PRÉVIA DESBLOQUEIO)
		,ISNULL(
			(
				SELECT	
						SUM(BN201_VL_TCONTRA) 
				FROM	BN201
				WHERE
					BN201_NR_GRUPO	= BN200.BN200_NR_GRUPO
				AND BN201_NR_INST	= BN200.BN200_NR_INST
				AND BN201_NR_CNPJ	= BN200.BN200_NR_CNPJ
				AND BN201_ST_CONTRATO IN('L','P')
			),0			
		)AS BN200_TT_CONTRA_ATIVO
		
		-- TOTAL DE CONTRATOS (ATUALIZADO) (STATUS LIBERADO E PRÉVIA DESBLOQUEIO)
		/*
		,ISNULL(
			(
				SELECT	
						SUM(BN201_VL_CONTRATU) 
				FROM	BN201
				WHERE
					BN201_NR_GRUPO	= BN200.BN200_NR_GRUPO
				AND BN201_NR_INST	= BN200.BN200_NR_INST
				AND BN201_NR_CNPJ	= BN200.BN200_NR_CNPJ
				AND BN201_ST_CONTRATO IN('L','P')
			),0			
		)AS BN200_QT_CONTRATU
		*/
		
		-- VALOR TOTAL DOS CONTRATOS (ATUALIZADO) (STATUS LIBERADO E PRÉVIA DESBLOQUEIO)
		,ISNULL(
			(
				SELECT	
						SUM(BN201_VL_CONTRATU) 
				FROM	BN201
				WHERE
					BN201_NR_GRUPO	= BN200.BN200_NR_GRUPO
				AND BN201_NR_INST	= BN200.BN200_NR_INST
				AND BN201_NR_CNPJ	= BN200.BN200_NR_CNPJ
				AND BN201_ST_CONTRATO IN('L','P')
			),0			
		)AS BN200_TT_CONTRATU		
				
		-- TOTAL DE CONTRATOS QUE A EMPRESA POSSUI INATIVOS (STATUS <> LIBERADO E PRÉVIA DESBLOQUEIO)
		,ISNULL(
			(
				SELECT	COUNT(BN201_VL_TCONTRA) 
				FROM	BN201
				WHERE
					BN201_NR_GRUPO	= BN200.BN200_NR_GRUPO
				AND BN201_NR_INST	= BN200.BN200_NR_INST
				AND BN201_NR_CNPJ	= BN200.BN200_NR_CNPJ
				AND BN201_ST_CONTRATO NOT IN('L','P')
			),0
		)	AS BN200_QT_CONTRA_INATIVO
				
		-- VALOR TOTAL DOS CONTRATOS QUE A EMPRESA POSSUI INATIVOS (STATUS <> LIBERADO E PRÉVIA DESBLOQUEIO)
		,ISNULL(
			(
				SELECT	
						SUM(BN201_VL_TCONTRA) 
				FROM	BN201
				WHERE
					BN201_NR_GRUPO	= BN200.BN200_NR_GRUPO
				AND BN201_NR_INST	= BN200.BN200_NR_INST
				AND BN201_NR_CNPJ	= BN200.BN200_NR_CNPJ
				AND BN201_ST_CONTRATO NOT IN('L','P')
			),0			
		)AS BN200_TT_CONTRA_INATIVO
		
		/*
		,VW_BN019_ST_ATUAL.BN019_NR_STATUS_MAX
		,VW_BN019_ST_ATUAL.BN019_NR_STATUSP
		*/
		
	FROM	BN200 AS BN200

	LEFT OUTER JOIN BN002 AS BN002
	ON	BN002.BN002_NR_GRUPO = BN200.BN200_NR_GRUPO
	AND BN002.BN002_NR_INST	 = BN200.BN200_NR_INST
	
	
	INNER JOIN VW_BN019_ST_ATUAL AS VW_BN019_ST_ATUAL -- NECESSÁRIO JOIN COM VIEW PARA MANTER CÓDIGO LIMPO
	ON BN200.BN200_NR_GRUPO = VW_BN019_ST_ATUAL.BN019_NR_GRUPO
	AND BN200.BN200_NR_INST = VW_BN019_ST_ATUAL.BN019_NR_INST  
	AND BN200.BN200_NR_CNPJ = VW_BN019_ST_ATUAL.BN200_NR_CNPJ
	/**/

	GROUP BY
		BN200_NR_GRUPO
		,BN200_NR_INST
		,BN200.BN200_NR_CNPJ
		/*
		,BN200.BN200_LT_RATCALCBC
		,BN200.BN200_LT_RISKSCOR
		,BN200.BN200_QT_QTDEIF
		,BN200.BN200_NM_EEMCCB*/

		,BN002.BN002_NM_INST  
		/*
		,VW_BN019_ST_ATUAL.BN019_NR_STATUS_MAX
		,VW_BN019_ST_ATUAL.BN019_NR_STATUSP
		*/

GO


/*
Exemplo:
*/
SELECT	* 
FROM	VW_BN200_INST
WHERE	BN200_NR_CNPJ = 88368000153


