-- Configura View
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- Apaga view
IF  EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[VW_BN402_BA]'))
DROP VIEW [dbo].[VW_BN402_BA]
GO

-- Tela Balancete
-- Cria View
CREATE VIEW [dbo].[VW_BN402_BA]
WITH ENCRYPTION
AS
  SELECT
	BN402_NR_GRUPO,
	BN402_NR_INST,
	BN402_DT_MOVTO,
	BN402_NR_PROD,
    BN402_NR_BANCO,
    BN402_NR_AGENC,
    BN402_NR_CONTA,
    		
	SUM( CASE  WHEN BN402_TP_ACUM  = 1 THEN BN402_VL_VALOR ELSE 0 END) AS BN402_VL_VALOR1, -- 1-SALDO ANTERIOR
	SUM( CASE  WHEN BN402_TP_ACUM  = 1 THEN BN402_QT_TOTAL ELSE 0 END) AS BN402_QT_TOTAL1,

	SUM( CASE  WHEN BN402_TP_ACUM  = 2 THEN BN402_VL_VALOR ELSE 0 END) AS BN402_VL_VALOR2, -- 2-ENTRADAS
	SUM( CASE  WHEN BN402_TP_ACUM  = 2 THEN BN402_QT_TOTAL ELSE 0 END) AS BN402_QT_TOTAL2,

	SUM( CASE  WHEN BN402_TP_ACUM  = 3 THEN BN402_VL_VALOR ELSE 0 END) AS BN402_VL_VALOR3, -- 3-LIQUIDADOS
	SUM( CASE  WHEN BN402_TP_ACUM  = 3 THEN BN402_QT_TOTAL ELSE 0 END) AS BN402_QT_TOTAL3,

	SUM( CASE  WHEN BN402_TP_ACUM  = 4 THEN BN402_VL_VALOR ELSE 0 END) AS BN402_VL_VALOR4, -- 4-BAIXA SOLICITADA
	SUM( CASE  WHEN BN402_TP_ACUM  = 4 THEN BN402_QT_TOTAL ELSE 0 END) AS BN402_QT_TOTAL4,

	SUM( CASE  WHEN BN402_TP_ACUM  = 5 THEN BN402_VL_VALOR ELSE 0 END) AS BN402_VL_VALOR5, -- 5-BAIXA POR DECURSO DE PRAZO
	SUM( CASE  WHEN BN402_TP_ACUM  = 5 THEN BN402_QT_TOTAL ELSE 0 END) AS BN402_QT_TOTAL5,

	SUM( CASE  WHEN BN402_TP_ACUM  = 6 THEN BN402_VL_VALOR ELSE 0 END) AS BN402_VL_VALOR6, -- 6-DEVOLUCAO POR REJEICAO
	SUM( CASE  WHEN BN402_TP_ACUM  = 6 THEN BN402_QT_TOTAL ELSE 0 END) AS BN402_QT_TOTAL6,

	SUM( CASE  WHEN BN402_TP_ACUM  = 10 THEN BN402_VL_VALOR ELSE 0 END) AS BN402_VL_VALOR10, -- 10-SALDO ATUAL
	SUM( CASE  WHEN BN402_TP_ACUM  = 10 THEN BN402_QT_TOTAL ELSE 0 END) AS BN402_QT_TOTAL10,

	-- PRODUTO
	BN004.BN004_NM_PROD

 FROM BN402 AS BN402

 LEFT OUTER JOIN BN004 AS BN004  -- PRODUTO
 ON  BN004.BN004_NR_PROD = BN402.BN402_NR_PROD 

 LEFT OUTER JOIN BN007 AS BN007  -- BANCO
 ON  BN007.BN007_NR_BANCO = BN402.BN402_NR_BANCO 


--where BN402_NR_BANCO= 1

 GROUP BY 
	BN402_NR_GRUPO,
	BN402_NR_INST,
	BN402_DT_MOVTO,
	BN402_NR_PROD,
	BN004_NM_PROD,
    BN402_NR_BANCO,
    BN402_NR_AGENC,
    BN402_NR_CONTA
-- SELECT TOP 5 * FROM BN402 

/*
 SELECT 
 	BN402_NR_GRUPO,
	BN402_NR_INST,
	BN402_DT_MOVTO,
	BN402_NR_PROD,
	BN004_NM_PROD,
	SUM(BN402_VL_VALOR1)  AS BN402_VL_VALOR1, 
	SUM(BN402_QT_TOTAL1)  AS BN402_QT_TOTAL1,
	SUM(BN402_VL_VALOR2)  AS BN402_VL_VALOR2, 
	SUM(BN402_QT_TOTAL2)  AS BN402_QT_TOTAL2,
	SUM(BN402_VL_VALOR3)  AS BN402_VL_VALOR3, 
	SUM(BN402_QT_TOTAL3)  AS BN402_QT_TOTAL3,
	SUM(BN402_VL_VALOR4)  AS BN402_VL_VALOR4, 
	SUM(BN402_QT_TOTAL4)  AS BN402_QT_TOTAL4,
	SUM(BN402_VL_VALOR5)  AS BN402_VL_VALOR5, 
	SUM(BN402_QT_TOTAL5)  AS BN402_QT_TOTAL5 ,
	SUM(BN402_VL_VALOR6)  AS BN402_VL_VALOR6, 
	SUM(BN402_QT_TOTAL6)  AS BN402_QT_TOTAL6,
	SUM(BN402_VL_VALOR10) AS BN402_VL_VALOR10,
	SUM(BN402_QT_TOTAL10) AS BN402_QT_TOTAL10
  FROM 
  
 (SELECT 



) AGRUPA

 GROUP BY 
	BN402_NR_GRUPO,
	BN402_NR_INST,
	BN402_DT_MOVTO,
	BN402_NR_PROD,
	BN004_NM_PROD
    
 
*/
 
 
 
 