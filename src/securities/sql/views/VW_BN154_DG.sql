-- Configura View
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- Apaga view
IF  EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[VW_BN154_DG]'))
DROP VIEW [dbo].[VW_BN154_DG]
GO


-- Relatório Resumo Diário de Garantias
-- Cria View
CREATE VIEW [dbo].[VW_BN154_DG]
WITH ENCRYPTION
AS
	SELECT 
		BN154.BN154_NR_GRUPO
		,BN154.BN154_NR_INST
		,BN154.BN154_NR_LOTE
		,BN154.BN154_DT_BASE
		,BN154.BN154_NR_BANCO
		,BN154.BN154_NR_AGENC
		,BN154.BN154_NR_CONTA
		,BN154.BN154_TT_PARC
		,BN154.BN154_TT_NOM
		,BN154.BN154_TT_PRES
		,BN154.BN154_TT_EXIG
		,BN154.BN154_NR_OPESIS
		,BN154.BN154_DT_INCSIS
		,BN154.BN154_DT_ATUSIS

		-- DADOS DA CONTA / ENTIDADE
		,BN009.BN009_NM_CONTA
		,BN009.BN009_NR_CPFCNPJ

		,BN001.BN001_NM_GRUPO

		,BN002.BN002_NM_INST
		,BN002.BN002_NR_CNPJ
	  
	  -- TOTAL DE CONTRATOS
	    ,BN154.BN154_TT_CONTRA
		/*
		,ISNULL(
			(
				SELECT	COUNT(BN201.BN201_NR_CONTRAOR) 
				FROM	BN201 AS BN201
				WHERE
					BN201.BN201_NR_GRUPO	= VW_BN201.BN201_NR_GRUPO
				AND BN201.BN201_NR_INST		= VW_BN201.BN201_NR_INST
				AND BN201.BN201_NR_LOTE		= VW_BN201.BN201_NR_LOTE				
				AND BN201.BN201_NR_CNPJ		= VW_BN201.BN201_NR_CNPJ				
		
			),0
		)	AS BN154_TT_CONTRA
		*/
		

		,MAX(VW_BN201.BN200_NM_EEMCCB) AS BN200_NM_EEMCCB
		,VW_BN201.BN201_NR_CNPJ
		--,VW_BN201.BN201_ST_CONTRATO

		,(SELECT
				COUNT(*)
			 FROM BN201 AS BN201
		 
			 INNER JOIN BN004 AS BN004
			 ON BN004.BN004_NR_PROD = BN201.BN201_NR_PROD
		 
			 WHERE 1=1
			 AND BN201_NR_LOTE		= BN154.BN154_NR_LOTE		 		
			 --AND BN201_ST_CONTRATO  IN ('L','C','N')
		 
			 AND BN004_TP_PROD = 'B'  
		) AS CCB_COUNT

	FROM 
		dbo.BN154 AS BN154
	  
	 
	LEFT OUTER JOIN BN009 AS BN009  -- CONTA
	ON  BN009.BN009_NR_BANCO 	= BN154.BN154_NR_BANCO
	AND BN009.BN009_NR_AGENC 	= BN154.BN154_NR_AGENC
	AND BN009.BN009_NR_CONTA 	= BN154.BN154_NR_CONTA


	INNER JOIN BN001 AS BN001
	ON BN154.BN154_NR_GRUPO = BN001.BN001_NR_GRUPO

	INNER JOIN BN002 AS BN002
	ON BN154.BN154_NR_INST = BN002.BN002_NR_INST
	AND BN154.BN154_NR_GRUPO =  BN002.BN002_NR_GRUPO

	-- CCB
	LEFT OUTER JOIN VW_BN201 AS VW_BN201
	ON	VW_BN201.BN201_NR_GRUPO		= BN154.BN154_NR_GRUPO
	AND	VW_BN201.BN201_NR_INST		= BN154.BN154_NR_INST
	AND VW_BN201.BN201_NR_LOTE		= BN154.BN154_NR_LOTE
	AND VW_BN201.BN201_NR_CNPJ		= BN154.BN154_NR_CNPJ
	--AND VW_BN201.TABLE_NAME = 'BN201'

	GROUP BY

	BN154.BN154_NR_GRUPO
	,BN154.BN154_NR_INST
	,BN154.BN154_NR_LOTE
	,BN154.BN154_DT_BASE
	,BN154.BN154_NR_BANCO
	,BN154.BN154_NR_AGENC
	,BN154.BN154_NR_CONTA
	,BN154.BN154_TT_CONTRA
	,BN154.BN154_TT_PARC
	,BN154.BN154_TT_NOM
	,BN154.BN154_TT_PRES
	,BN154.BN154_TT_EXIG
	,BN154.BN154_NR_OPESIS
	,BN154.BN154_DT_INCSIS
	,BN154.BN154_DT_ATUSIS

	-- DADOS DA CONTA / ENTIDADE
	,BN009.BN009_NM_CONTA
	,BN009.BN009_NR_CPFCNPJ

	,BN001.BN001_NM_GRUPO

	,BN002.BN002_NM_INST
	,BN002.BN002_NR_CNPJ

	,BN201_NR_GRUPO
	,BN201_NR_INST
	,BN201_NR_LOTE
	
	,VW_BN201.BN201_NR_CNPJ	

GO

/*
Exemplo:
SELECT	*
FROM	BN154
WHERE	1 = 1
--AND BN154_NR_GRUPO	= 50940
--AND BN154_NR_INST	= 92228
AND BN154_NR_LOTE	= 10000003

*/
--793


