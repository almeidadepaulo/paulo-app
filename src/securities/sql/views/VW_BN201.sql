-- Configura View
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- Apaga view
IF  EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[VW_BN201]'))
DROP VIEW [dbo].[VW_BN201]
GO

-- Cria View
CREATE VIEW [dbo].[VW_BN201]
WITH ENCRYPTION
AS
  SELECT 
  
   'BN201' AS TABLE_NAME
    ,BN201.BN201_NR_GRUPO
	,BN201.BN201_NR_INST
	,BN201.BN201_NR_CNPJ
	,BN201.BN201_NR_REME
	,LTRIM(RTRIM(BN201.BN201_NR_CONTRAOR)) AS BN201_NR_CONTRAOR
	,BN201.BN201_NR_ATIVO
	,BN201.BN201_TP_ATIVO
	,BN201.BN201_TP_ORCRED
	,BN201.BN201_TP_FLXCONTRA
	,BN201.BN201_DT_ECONTRA
	,BN201.BN201_DT_VCONTRA
	,BN201.BN201_VL_TCONTRA
	,BN201.BN201_VL_CONTRATU
	,BN201.BN201_QT_TTPARCON
	,BN201.BN201_QT_PARCEFGC
	,BN201.BN201_NR_RTIDTXF
	,BN201.BN201_VL_PRCTXF
	,BN201.BN201_VL_TXJURANU
	--,BN201.BN201_NR_PROD
	,BN201.BN201_QT_PRZOPER
	,BN201.BN201_ST_CALCEX1P
	,BN201.BN201_ST_CONTRATO
	/*	
	,BN201_ST_CONTRATO = 
 	CASE
    	WHEN BN200.BN200_ST_CONCNPJ = 'N' THEN 'R'
        ELSE BN201_ST_CONTRATO
    END
    */
    
	
	,BN201.BN201_ST_CONTRATO AS BN201_ST_CONTRATO_AUX-- Utilizada na tela de Validade de Remessa (Para que seja possï¿½vel realizar controle de mudanï¿½a do status sem a confirmaï¿½ï¿½o imediata)
	,BN201_ST_DEVSOL		-- STATUS DE DEVOLUï¿½ï¿½O
	,BN201.BN201_NR_OPESIS
	,BN201.BN201_DT_INCSIS
	,BN201.BN201_DT_ATUSIS
	,BN201.BN201_NR_LOTE
	
	,BN201.BN201_DT_DEVOLU

	,BN200.BN200_NR_GRUPO
	,BN200.BN200_NR_INST
	,BN200.BN200_NR_CNPJ
	,BN200.BN200_NR_REME
	,BN200.BN200_NR_PROD
	,BN200.BN200_NR_BANCETIP
	,BN200.BN200_NM_EEMCCB
	,BN200.BN200_NR_CNAESUBC
	,BN200.BN200_LT_ENDEEMP
	,BN200.BN200_LT_BAIRROEMP
	,BN200.BN200_LT_CIDADEEMP
	,BN200.BN200_LT_UFEMP
	,BN200.BN200_NR_CEPEMP
	,BN200.BN200_QT_QTDEIF  
	,BN200.BN200_LT_RATEMP
	,BN200.BN200_LT_RATCALCFGC
	,BN200.BN200_LT_RATCALCBC
	,BN200.BN200_LT_RISKSCOR
	,BN200.BN200_VL_TTREME 
	,BN200.BN200_VL_TTCONTRA  
	,BN200.BN200_VL_CNPJXREME 
	,BN200.BN200_VL_CNPJXPR1 
	,BN200.BN200_DT_GRAVREME 
	,BN200.BN200_ST_EMPRESA
	,BN200.BN200_NR_OPESIS
	,BN200.BN200_DT_INCSIS
	,BN200.BN200_DT_ATUSIS
	,BN200.BN200_ST_CONCNPJ
	,BN200.BN200_ST_CONCREME
	--,BN200_RAZAO_GARANTIA

	
	,BN002.BN002_NR_INST
	,BN002.BN002_NM_INST
	
	,VW_BN019_ST_ATUAL.BN019_NR_STATUS_MAX
	,VW_BN019_ST_ATUAL.BN019_NR_STATUSP
    
    ,BN004.BN004_NM_PROD 
    ,BN004.BN004_QT_DEVOLU       
    --,DATEADD(D,BN004.BN004_QT_DEVOLU,BN200.BN200_DT_ATUSIS)  AS BN201_DT_DEVOLU
        
	,(
		SELECT	TOP 1 
				BN015_NM_MENSAG
		FROM VW_BN203 
		WHERE 1=1
		AND BN203_NR_GRUPO		= BN201_NR_GRUPO
		AND BN203_NR_INST		= BN201_NR_INST
		AND BN203_NR_CNPJ		= BN201_NR_CNPJ
		AND BN203_NR_REME		= BN201_NR_REME
		AND (BN203_NR_CONTRAOR	= BN201_NR_CONTRAOR OR BN203_NR_CONTRAOR = '0')
		ORDER BY BN203_DT_INCSIS DESC
	) AS ULTIMO_ERRO -- ULTIMO ERRO
	
	
	,BN201_NR_MOTDEV	
	,(
		SELECT	TOP 1 
				BN015_NM_MENSAG
		FROM BN015
		WHERE 1=1
		AND BN015_TP_MENSAG		= 16 -- MOTIVO SOLICITAï¿½ï¿½O IF PARA DEVOLUï¿½ï¿½O
		AND BN015_NR_MENSAG		= BN201_NR_MOTDEV		
	) AS BN201_NM_MOTDEV -- MOTIVO PARA SOLICITAï¿½ï¿½O IF PARA DEVOLUï¿½ï¿½O
	
	
	,(
		SELECT	TOP 1 
				BN015_NM_MENSAG
		FROM VW_BN203 
		WHERE 1=1
		AND BN203_NR_GRUPO		= BN201_NR_GRUPO
		AND BN203_NR_INST		= BN201_NR_INST
		AND BN203_NR_CNPJ		= BN201_NR_CNPJ
		--AND BN203_NR_REME		= BN201_NR_REME -- Paulo Almeida informou que não precisa desta ligação, pois o número é diferente
		AND BN203_NR_CONTRAOR	= BN201_NR_CONTRAOR
		AND BN015_TP_MENSAG		= 15
		ORDER BY BN203_DT_INCSIS DESC
	) AS SOLICITACAO_DEV_RETORNO -- ULTIMO RETORNO DE SOLICITAï¿½ï¿½O DE DEVOLUï¿½ï¿½O

	,(
		SELECT	TOP 1 
				BN015_NR_MENSAG
		FROM VW_BN203 
		WHERE 1=1
		AND BN203_NR_GRUPO		= BN201_NR_GRUPO
		AND BN203_NR_INST		= BN201_NR_INST
		AND BN203_NR_CNPJ		= BN201_NR_CNPJ
		--AND BN203_NR_REME		= BN201_NR_REME -- Paulo Almeida informou que não precisa desta ligação, pois o número é diferente
		AND BN203_NR_CONTRAOR	= BN201_NR_CONTRAOR
		AND BN015_TP_MENSAG		= 15
		ORDER BY BN203_DT_INCSIS DESC
	) AS SOLICITACAO_DEV_RETORNO_NR -- ULTIMO RETORNO DE SOLICITAï¿½ï¿½O DE DEVOLUï¿½ï¿½O

	,(
		SELECT	
			TOP 1
			BN015_NR_MENSAG
		FROM VW_BN203 
		WHERE 1=1
		AND BN203_NR_GRUPO		= BN201_NR_GRUPO
		AND BN203_NR_INST		= BN201_NR_INST
		AND BN203_NR_CNPJ		= BN201_NR_CNPJ
		AND BN203_NR_REME		= BN201_NR_REME
		AND BN203_NR_CONTRAOR	= BN201_NR_CONTRAOR
		AND BN015_TP_MENSAG		= 14
		AND BN015_NR_MENSAG		IN (5998,5999)
		ORDER BY BN203_DT_INCSIS DESC
	) AS ACEITE_USUARIO -- Recupera (5998:Usuario aceitou contrato na validaï¿½ï¿½o de remessa ou 5999 Usuï¿½rio recusou contrato na validaï¿½ï¿½o de remessa)
	
		
	--,BN205.BN205_QT_IFEM
	
	,RENTABILIDADE.BN015_NM_MENSAG AS BN201_NM_RTIDTXF
    ,Cast(BN017.BN017_NR_SUBCLA as varchar)+' - '+BN017.BN017_NM_CNAE AS BN017_NR_NM_CNAE

	
	,VW_BN022.BN022_VL_COMUM AS BN200_RAZAO_GARANTIA

	,BN205.BN205_TT_APFGCEM
	,BN205.BN205_TT_APFGCIF

	/*
	,(SELECT  MAX(BN206_CD_CONREG) FROM BN206 
			WHERE    BN206_CD_CONCRE = RIGHT('0000000000'+BN201.BN201_NR_CONTRAOR,10)
			AND      BN206_CD_EMITEN = BN201.BN201_NR_CNPJ) AS BN206_CD_CONREG

	,(SELECT TOP 1 BN420_TP_STATUS FROM BN420 
			WHERE BN420_NR_CETIP = (SELECT  MAX(BN206_CD_CONREG) FROM BN206 
									WHERE    BN206_CD_CONCRE = RIGHT('0000000000'+BN201.BN201_NR_CONTRAOR,10)
									AND      BN206_CD_EMITEN = BN201.BN201_NR_CNPJ)
			AND BN420_NR_CONTRA = SUBSTRING(BN201.BN201_NR_CONTRAOR,PATINDEX('%[^0]%',BN201.BN201_NR_CONTRAOR),LEN(BN201.BN201_NR_CONTRAOR))
			ORDER BY BN420_DT_ATUSIS DESC
	) AS BN420_TP_STATUS

	,(SELECT TOP 1 BN420_TP_OPER FROM BN420 
			WHERE BN420_NR_CETIP = (SELECT  MAX(BN206_CD_CONREG) FROM BN206 
									WHERE    BN206_CD_CONCRE = RIGHT('0000000000'+BN201.BN201_NR_CONTRAOR,10)
									AND      BN206_CD_EMITEN = BN201.BN201_NR_CNPJ)
			AND BN420_NR_CONTRA = SUBSTRING(BN201.BN201_NR_CONTRAOR,PATINDEX('%[^0]%',BN201.BN201_NR_CONTRAOR),LEN(BN201.BN201_NR_CONTRAOR))
			ORDER BY BN420_DT_ATUSIS DESC
	) AS BN420_TP_OPER
	*/	
	
	,(SELECT  MAX(BN206_CD_CONREG) FROM BN206 
			WHERE    BN206.BN206_NR_ATIVO   =  BN201.BN201_NR_ATIVO) AS BN206_CD_CONREG

	,(SELECT TOP 1 BN420_TP_STATUS FROM BN420 
			WHERE BN420_NR_CETIP = (SELECT  MAX(BN206_CD_CONREG) FROM BN206 
									WHERE    BN206.BN206_NR_ATIVO   =  BN201.BN201_NR_ATIVO)
			AND BN420_NR_CONTRA = SUBSTRING(BN201.BN201_NR_CONTRAOR,PATINDEX('%[^0]%',BN201.BN201_NR_CONTRAOR),LEN(BN201.BN201_NR_CONTRAOR))
			ORDER BY BN420_DT_ATUSIS DESC
	) AS BN420_TP_STATUS

	,(SELECT TOP 1 BN420_TP_OPER FROM BN420 
			WHERE BN420_NR_CETIP = (SELECT  MAX(BN206_CD_CONREG) FROM BN206 
									WHERE    BN206.BN206_NR_ATIVO   =  BN201.BN201_NR_ATIVO)
			AND BN420_NR_CONTRA = SUBSTRING(BN201.BN201_NR_CONTRAOR,PATINDEX('%[^0]%',BN201.BN201_NR_CONTRAOR),LEN(BN201.BN201_NR_CONTRAOR))
			ORDER BY BN420_DT_ATUSIS DESC
	) AS BN420_TP_OPER					
	
  FROM BN201 AS BN201
  
  INNER JOIN BN200 AS BN200
  ON BN200.BN200_NR_GRUPO = BN201.BN201_NR_GRUPO
  AND BN200.BN200_NR_INST = BN201.BN201_NR_INST
  AND BN200.BN200_NR_CNPJ = BN201.BN201_NR_CNPJ
  AND BN200.BN200_NR_REME = BN201.BN201_NR_REME  
 
  
  INNER JOIN BN002 AS BN002
  --ON BN002.BN002_NR_CNPJ = BN200.BN200_NR_CNPJ
  ON BN002.BN002_NR_GRUPO = BN201.BN201_NR_GRUPO
  AND BN002.BN002_NR_INST = BN201.BN201_NR_INST
  
  
  INNER JOIN VW_BN019_ST_ATUAL AS VW_BN019_ST_ATUAL -- NECESSï¿½RIO JOIN COM VIEW PARA MANTER Cï¿½DIGO LIMPO
  ON BN200.BN200_NR_GRUPO = VW_BN019_ST_ATUAL.BN019_NR_GRUPO
  AND BN200.BN200_NR_INST = VW_BN019_ST_ATUAL.BN019_NR_INST  
  AND BN200.BN200_NR_REME = VW_BN019_ST_ATUAL.BN019_NR_REME  
  AND BN200.BN200_NR_CNPJ = VW_BN019_ST_ATUAL.BN200_NR_CNPJ
  /**/
  LEFT OUTER JOIN BN004 AS BN004
  ON BN004.BN004_NR_PROD = BN200.BN200_NR_PROD
  

  
  LEFT OUTER JOIN BN015 AS RENTABILIDADE
  ON RENTABILIDADE.BN015_NR_MENSAG	= BN201.BN201_NR_RTIDTXF
  AND RENTABILIDADE.BN015_TP_MENSAG	= 3 -- 003 Rentabilidade

  LEFT OUTER JOIN BN017 AS BN017
  ON BN200.BN200_NR_CNAESUBC = BN017.BN017_NR_SUBCLA

  LEFT OUTER JOIN VW_BN022 AS VW_BN022
  ON VW_BN022.BN022_NR_PROD		= BN200.BN200_NR_PROD
  AND VW_BN022.BN015_NM_MENSAG	= BN200.BN200_LT_RATCALCBC
  AND VW_BN022.BN015_TP_MENSAG	= 9 -- RAZÃO DE GARANTIA*/

  LEFT OUTER JOIN BN205 AS BN205 -- NECESSÁRIO LEFT OUTER JOIN PARA QUE SEJA POSSÍVEL RECUPERA INFORMAÇÕES DE REMESSAS RECUSADAS (Que não gera registro na BN205)
  ON BN200.BN200_NR_GRUPO = BN205.BN205_NR_GRUPO
  AND BN200.BN200_NR_INST = BN205.BN205_NR_INST    
  --AND BN200.BN200_NR_CNPJ = BN205.BN205_NR_CNPJ 
  AND BN200.BN200_LT_RATCALCBC = BN205.BN205_NM_RATEM
  --AND ((BN205_TP_CLIENTE = 'C' AND BN200_QT_QTDEIF > 1) OR (BN205_TP_CLIENTE = 'E' AND BN200_QT_QTDEIF = 1))  
  AND BN205.BN205_TP_CLIENTE =	(CASE
    								WHEN BN200.BN200_QT_QTDEIF = 1 THEN 'E'
									ELSE 'C'
								END)


UNION ALL -- CHAMADO 102

  SELECT 
	'BN211' AS TABLE_NAME
	,BN211.BN211_NR_GRUPO 
	,BN211.BN211_NR_INST
	,BN211.BN211_NR_CNPJ
	,BN211.BN211_NR_REME
	,LTRIM(RTRIM(BN211.BN211_NR_CONTRAOR)) AS BN211_NR_CONTRAOR
	,BN211.BN211_NR_ATIVO
	,BN211.BN211_TP_ATIVO
	,BN211.BN211_TP_ORCRED
	,BN211.BN211_TP_FLXCONTRA
	,BN211.BN211_DT_ECONTRA
	,BN211.BN211_DT_VCONTRA
	,BN211.BN211_VL_TCONTRA
	,BN211.BN211_VL_CONTRATU
	,BN211.BN211_QT_TTPARCON
	,BN211.BN211_QT_PARCEFGC
	,BN211.BN211_NR_RTIDTXF
	,BN211.BN211_VL_PRCTXF
	,BN211.BN211_VL_TXJURANU
	--,BN211.BN211_NR_PROD
	,BN211.BN211_QT_PRZOPER
	,BN211.BN211_ST_CALCEX1P
	,BN211.BN211_ST_CONTRATO
	/*	
	,BN211_ST_CONTRATO = 
 	CASE
    	WHEN BN200.BN200_ST_CONCNPJ = 'N' THEN 'R'
        ELSE BN211_ST_CONTRATO
    END
    */
    
	
	,BN211.BN211_ST_CONTRATO AS BN211_ST_CONTRATO_AUX-- Utilizada na tela de Validade de Remessa (Para que seja possï¿½vel realizar controle de mudanï¿½a do status sem a confirmaï¿½ï¿½o imediata)
	,' ' AS BN211_ST_DEVSOL		
	,BN211.BN211_NR_OPESIS
	,BN211.BN211_DT_INCSIS
	,BN211.BN211_DT_ATUSIS
	,BN211.BN211_NR_LOTE
	
	,0 AS BN211_DT_DEVOLU

	,BN200.BN200_NR_GRUPO
	,BN200.BN200_NR_INST
	,BN200.BN200_NR_CNPJ
	,BN200.BN200_NR_REME
	,BN200.BN200_NR_PROD
	,BN200.BN200_NR_BANCETIP
	,BN200.BN200_NM_EEMCCB
	,BN200.BN200_NR_CNAESUBC
	,BN200.BN200_LT_ENDEEMP
	,BN200.BN200_LT_BAIRROEMP
	,BN200.BN200_LT_CIDADEEMP
	,BN200.BN200_LT_UFEMP
	,BN200.BN200_NR_CEPEMP
	,BN200.BN200_QT_QTDEIF  
	,BN200.BN200_LT_RATEMP
	,BN200.BN200_LT_RATCALCFGC
	,BN200.BN200_LT_RATCALCBC
	,BN200.BN200_LT_RISKSCOR
	,BN200.BN200_VL_TTREME 
	,BN200.BN200_VL_TTCONTRA  
	,BN200.BN200_VL_CNPJXREME 
	,BN200.BN200_VL_CNPJXPR1 
	,BN200.BN200_DT_GRAVREME 
	,BN200.BN200_ST_EMPRESA
	,BN200.BN200_NR_OPESIS
	,BN200.BN200_DT_INCSIS
	,BN200.BN200_DT_ATUSIS
	,BN200.BN200_ST_CONCNPJ
	,BN200.BN200_ST_CONCREME
	--,BN200_RAZAO_GARANTIA

	
	,BN002.BN002_NR_INST
	,BN002.BN002_NM_INST
	
	,VW_BN019_ST_ATUAL.BN019_NR_STATUS_MAX
	,VW_BN019_ST_ATUAL.BN019_NR_STATUSP
    
    ,BN004.BN004_NM_PROD 
    ,BN004.BN004_QT_DEVOLU       
    --,DATEADD(D,BN004.BN004_QT_DEVOLU,BN200.BN200_DT_ATUSIS)  AS BN211_DT_DEVOLU
        
	,(
		SELECT	TOP 1 
				BN015_NM_MENSAG
		FROM VW_BN203 
		WHERE 1=1
		AND BN203_NR_GRUPO		= BN211_NR_GRUPO
		AND BN203_NR_INST		= BN211_NR_INST
		AND BN203_NR_CNPJ		= BN211_NR_CNPJ
		AND BN203_NR_REME		= BN211_NR_REME
		AND (BN203_NR_CONTRAOR	= BN211_NR_CONTRAOR OR BN203_NR_CONTRAOR = '0')
		ORDER BY BN203_DT_INCSIS DESC
	) AS ULTIMO_ERRO -- ULTIMO ERRO
	
	
	,0 AS BN211_NR_MOTDEV	
	,'' AS BN211_NM_MOTDEV -- MOTIVO PARA SOLICITAï¿½ï¿½O IF PARA DEVOLUï¿½ï¿½O
	
	
	,(
		SELECT	TOP 1 
				BN015_NM_MENSAG
		FROM VW_BN203 
		WHERE 1=1
		AND BN203_NR_GRUPO		= BN211_NR_GRUPO
		AND BN203_NR_INST		= BN211_NR_INST
		AND BN203_NR_CNPJ		= BN211_NR_CNPJ
		--AND BN203_NR_REME		= BN211_NR_REME -- Paulo Almeida informou que não precisa desta ligação, pois o número é diferente
		AND BN203_NR_CONTRAOR	= BN211_NR_CONTRAOR
		AND BN015_TP_MENSAG		= 15
		ORDER BY BN203_DT_INCSIS DESC
	) AS SOLICITACAO_DEV_RETORNO -- ULTIMO RETORNO DE SOLICITAï¿½ï¿½O DE DEVOLUï¿½ï¿½O

	,(
		SELECT	TOP 1 
				BN015_NR_MENSAG
		FROM VW_BN203 
		WHERE 1=1
		AND BN203_NR_GRUPO		= BN211_NR_GRUPO
		AND BN203_NR_INST		= BN211_NR_INST
		AND BN203_NR_CNPJ		= BN211_NR_CNPJ
		--AND BN203_NR_REME		= BN211_NR_REME -- Paulo Almeida informou que não precisa desta ligação, pois o número é diferente
		AND BN203_NR_CONTRAOR	= BN211_NR_CONTRAOR
		AND BN015_TP_MENSAG		= 15
		ORDER BY BN203_DT_INCSIS DESC
	) AS SOLICITACAO_DEV_RETORNO_NR -- ULTIMO RETORNO DE SOLICITAï¿½ï¿½O DE DEVOLUï¿½ï¿½O

	,(
		SELECT	
			TOP 1
			BN015_NR_MENSAG
		FROM VW_BN203 
		WHERE 1=1
		AND BN203_NR_GRUPO		= BN211_NR_GRUPO
		AND BN203_NR_INST		= BN211_NR_INST
		AND BN203_NR_CNPJ		= BN211_NR_CNPJ
		AND BN203_NR_REME		= BN211_NR_REME
		AND BN203_NR_CONTRAOR	= BN211_NR_CONTRAOR
		AND BN015_TP_MENSAG		= 14
		AND BN015_NR_MENSAG		IN (5998,5999)
		ORDER BY BN203_DT_INCSIS DESC
	) AS ACEITE_USUARIO -- Recupera (5998:Usuario aceitou contrato na validaï¿½ï¿½o de remessa ou 5999 Usuï¿½rio recusou contrato na validaï¿½ï¿½o de remessa)
	
		
	--,BN205.BN205_QT_IFEM
	
	,RENTABILIDADE.BN015_NM_MENSAG AS BN211_NM_RTIDTXF
    ,Cast(BN017.BN017_NR_SUBCLA as varchar)+' - '+BN017.BN017_NM_CNAE AS BN017_NR_NM_CNAE

	
	,VW_BN022.BN022_VL_COMUM AS BN200_RAZAO_GARANTIA

	,BN205.BN205_TT_APFGCEM
	,BN205.BN205_TT_APFGCIF
	
	,(SELECT  MAX(BN206_CD_CONREG) FROM BN206 
			WHERE    BN206_CD_CONCRE = RIGHT(BN211.BN211_NR_CONTRAOR,10)
			AND      BN206_CD_EMITEN = BN211.BN211_NR_CNPJ) AS BN206_CD_CONREG

	,(SELECT TOP 1 BN420_TP_STATUS FROM BN420 
			WHERE  BN420_NR_CETIP = (SELECT  MAX(BN206_CD_CONREG) FROM BN206 
									WHERE    BN206_CD_CONCRE = RIGHT(BN211.BN211_NR_CONTRAOR,10)
									AND      BN206_CD_EMITEN = BN211.BN211_NR_CNPJ)
					AND BN420_NR_CONTRA =  RIGHT(BN211.BN211_NR_CONTRAOR,20)
			ORDER BY BN420_DT_ATUSIS DESC
		) AS BN420_TP_STATUS

	,(SELECT TOP 1 BN420_TP_OPER FROM BN420 
			WHERE  BN420_NR_CETIP = (SELECT  MAX(BN206_CD_CONREG) FROM BN206 
									WHERE    BN206_CD_CONCRE = RIGHT(BN211.BN211_NR_CONTRAOR,10)
									AND      BN206_CD_EMITEN = BN211.BN211_NR_CNPJ)
					AND BN420_NR_CONTRA =  RIGHT(BN211.BN211_NR_CONTRAOR,20)
			ORDER BY BN420_DT_ATUSIS DESC
		) AS BN420_TP_OPER

  FROM BN211 AS BN211
    
  INNER JOIN BN200 AS BN200
  ON BN200.BN200_NR_GRUPO = BN211.BN211_NR_GRUPO
  AND BN200.BN200_NR_INST = BN211.BN211_NR_INST
  AND BN200.BN200_NR_CNPJ = BN211.BN211_NR_CNPJ
  AND BN200.BN200_NR_REME = BN211.BN211_NR_REME  
 
  
  INNER JOIN BN002 AS BN002
  --ON BN002.BN002_NR_CNPJ = BN200.BN200_NR_CNPJ
  ON BN002.BN002_NR_GRUPO = BN211.BN211_NR_GRUPO
  AND BN002.BN002_NR_INST = BN211.BN211_NR_INST
  
  
  INNER JOIN VW_BN019_ST_ATUAL AS VW_BN019_ST_ATUAL -- NECESSï¿½RIO JOIN COM VIEW PARA MANTER Cï¿½DIGO LIMPO
  ON BN200.BN200_NR_GRUPO = VW_BN019_ST_ATUAL.BN019_NR_GRUPO
  AND BN200.BN200_NR_INST = VW_BN019_ST_ATUAL.BN019_NR_INST  
  AND BN200.BN200_NR_REME = VW_BN019_ST_ATUAL.BN019_NR_REME  
  AND BN200.BN200_NR_CNPJ = VW_BN019_ST_ATUAL.BN200_NR_CNPJ
  /**/
  LEFT OUTER JOIN BN004 AS BN004
  ON BN004.BN004_NR_PROD = BN200.BN200_NR_PROD
  

  
  LEFT OUTER JOIN BN015 AS RENTABILIDADE
  ON RENTABILIDADE.BN015_NR_MENSAG	= BN211.BN211_NR_RTIDTXF
  AND RENTABILIDADE.BN015_TP_MENSAG	= 3 -- 003 Rentabilidade

  LEFT OUTER JOIN BN017 AS BN017
  ON BN200.BN200_NR_CNAESUBC = BN017.BN017_NR_SUBCLA

  LEFT OUTER JOIN VW_BN022 AS VW_BN022
  ON VW_BN022.BN022_NR_PROD		= BN200.BN200_NR_PROD
  AND VW_BN022.BN015_NM_MENSAG	= BN200.BN200_LT_RATCALCBC
  AND VW_BN022.BN015_TP_MENSAG	= 9 -- RAZÃO DE GARANTIA

  LEFT OUTER JOIN BN205 AS BN205 -- NECESSÁRIO LEFT OUTER JOIN PARA QUE SEJA POSSÍVEL RECUPERA INFORMAÇÕES DE REMESSAS RECUSADAS (Que não gera registro na BN205)
  ON BN200.BN200_NR_GRUPO = BN205.BN205_NR_GRUPO
  AND BN200.BN200_NR_INST = BN205.BN205_NR_INST    
  --AND BN200.BN200_NR_CNPJ = BN205.BN205_NR_CNPJ 
  AND BN200.BN200_LT_RATCALCBC = BN205.BN205_NM_RATEM
  --AND ((BN205_TP_CLIENTE = 'C' AND BN200_QT_QTDEIF > 1) OR (BN205_TP_CLIENTE = 'E' AND BN200_QT_QTDEIF = 1))  
  AND BN205.BN205_TP_CLIENTE =	(CASE
    								WHEN BN200.BN200_QT_QTDEIF = 1 THEN 'E'
									ELSE 'C'
								END)
	
	
  WHERE BN211.BN211_ST_CONTRATO = '2' -- Paulo Almeida informou que somente os contratos com status 2 desta tabela sejam recuperados.

GO


