-- Configura View
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- Apaga view
IF  EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[VW_BN205_RATING]'))
DROP VIEW [dbo].[VW_BN205_RATING]
GO

-- Cria View
CREATE VIEW [dbo].[VW_BN205_RATING]
WITH ENCRYPTION
AS
  
		SELECT
		 BN205.BN205_NR_GRUPO	
		 ,BN205.BN205_NR_INST			 
		 --[!],BN205.BN205_TT_APFGCEM
		 ,BN205.BN205_TT_APFGCIF		 		 
		 ,'COMUM' AS TIPO	
		 ,BN205.BN205_TT_COINST 
		 		 
		 ,VW_BN200.BN200_NR_PROD 
		 ,VW_BN200.BN200_LT_RATCALCBC

		 --[!]	
		 -- Subtrai contratos que aparecem recusados em tela 
		 ,
		BN205.BN205_TT_APFGCEM
		-
		ISNULL
		(
			(
			SELECT
					SUM(BN201_VL_CONTRATU)
			FROM 
					VW_BN201
			WHERE	1=1
				AND	BN201_NR_GRUPO		= BN205.BN205_NR_GRUPO	
				AND BN201_NR_INST		= BN205.BN205_NR_INST	
				AND BN200_LT_RATCALCBC  = VW_BN200.BN200_LT_RATCALCBC	
				AND BN201_ST_CONTRATO   = 'A'			
				AND BN200_ST_CONCNPJ	= 'N'
				AND	BN200_QT_QTDEIF		> 1
				AND BN019_NR_STATUS_MAX = 4
				AND BN019_NR_STATUSP	= 2
			)
		,0) AS BN205_TT_APFGCEM
		 
	FROM BN205

	INNER JOIN VW_BN200 AS VW_BN200
	ON	VW_BN200.BN200_NR_GRUPO		= BN205.BN205_NR_GRUPO
	AND VW_BN200.BN200_NR_INST		= BN205.BN205_NR_INST	
	AND VW_BN200.BN200_LT_RATCALCBC = BN205.BN205_NM_RATEM


	WHERE BN205.BN205_TP_CLIENTE = 'C'
	--[!]
	/*	-- Para testes
		AND	VW_BN200.BN200_NR_GRUPO		= 12345678
		AND VW_BN200.BN200_NR_INST		= 54320004	
		AND VW_BN200.BN200_LT_RATCALCBC = 'AA'
	*/
	--[!]
	GROUP BY
		BN205.BN205_NR_GRUPO	
		,BN205.BN205_NR_INST
		,BN205.BN205_TT_APFGCEM	
		,BN205.BN205_TT_APFGCIF	
		,BN205.BN205_NM_RATEM
		,BN205.BN205_TT_COINST 
		
		,VW_BN200.BN200_NR_PROD
		,VW_BN200.BN200_LT_RATCALCBC
		
	
	UNION ALL

	SELECT
		 BN205.BN205_NR_GRUPO	
		 ,BN205.BN205_NR_INST			 
		 --[!],BN205.BN205_TT_APFGCEM
		 ,BN205.BN205_TT_APFGCIF		 		 
		 ,'EXCLUSIVO' AS TIPO	
		 ,BN205.BN205_TT_COINST 
		 		 
		 ,VW_BN200.BN200_NR_PROD 
		 ,VW_BN200.BN200_LT_RATCALCBC

		 --[!]	
		 -- Subtrai contratos que aparecem recusados em tela 
		 ,
		 BN205.BN205_TT_APFGCEM
		 -
		 ISNULL
		 (
			 (	SELECT
						SUM(BN201_VL_CONTRATU)
				FROM 
						VW_BN201
				WHERE	1=1
					AND	BN201_NR_GRUPO		= BN205.BN205_NR_GRUPO	
					AND BN201_NR_INST		= BN205.BN205_NR_INST	
					AND BN200_LT_RATCALCBC  = VW_BN200.BN200_LT_RATCALCBC	
					AND BN201_ST_CONTRATO   = 'A'			
					AND BN200_ST_CONCNPJ	= 'N'
					AND	BN200_QT_QTDEIF		= 1
					AND BN019_NR_STATUS_MAX = 4
					AND BN019_NR_STATUSP	= 2
				) 
			,0)AS BN205_TT_APFGCEM
		
	FROM BN205

	INNER JOIN VW_BN200 AS VW_BN200
	ON	VW_BN200.BN200_NR_GRUPO		= BN205.BN205_NR_GRUPO
	AND VW_BN200.BN200_NR_INST		= BN205.BN205_NR_INST
	AND VW_BN200.BN200_LT_RATCALCBC = BN205.BN205_NM_RATEM


	WHERE BN205.BN205_TP_CLIENTE = 'E'
	GROUP BY
		BN205.BN205_NR_GRUPO	
		,BN205.BN205_NR_INST
		,BN205.BN205_TT_APFGCEM	
		,BN205.BN205_TT_APFGCIF	
		,BN205.BN205_NM_RATEM
		,BN205.BN205_TT_COINST 
		
		,VW_BN200.BN200_NR_PROD
		,VW_BN200.BN200_LT_RATCALCBC		

GO

/*Exemplo*/
SELECT
	*
FROM 
	dbo.VW_BN205_RATING
/*
WHERE
	BN205_NR_GRUPO		= 5503849
AND BN205_NR_INST		= 5503849
AND BN200_NR_PROD		= 12
*/

