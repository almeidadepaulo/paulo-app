-- Configura View
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- Apaga view
IF  EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[VW_BN216_TT]'))
DROP VIEW [dbo].[VW_BN216_TT]
GO

-- Relatório Diário de Garantias

-- Cria View
CREATE VIEW [dbo].[VW_BN216_TT]
WITH ENCRYPTION
AS

SELECT
	 BN216.BN216_NR_GRUPO
	,BN216.BN216_NR_INST
	,ISNULL(CAST(BN216.BN216_DT_VENCTO AS VARCHAR),'TOTAL') AS DATA
	,BN216.BN216_VL_UNIT
	,BN216.BN216_QT_UNIT
	,SUM(BN216.BN216_VL_UNIT) AS BN216_VL_UNIT_SUM
	,SUM(BN216.BN216_QT_UNIT) AS BN216_QT_UNIT_SUM
	,BN216.BN216_TP_PAPEL
	,BN216.BN216_TP_STATUS
	,ISNULL(BN216.BN216_DT_VENCTO, 0) AS BN216_DT_VENCTO	

	,BN002.BN002_NM_INST
FROM
	BN216 AS BN216
	
	INNER JOIN BN002 AS BN002
	ON	BN002.BN002_NR_GRUPO = BN216.BN216_NR_GRUPO
	AND BN002.BN002_NR_INST  = BN216.BN216_NR_INST

GROUP BY 	
	
	ROLLUP ((BN216.BN216_NR_GRUPO, BN216.BN216_NR_INST, BN002.BN002_NM_INST, BN216.BN216_TP_PAPEL ,BN216.BN216_TP_STATUS), (BN216.BN216_DT_VENCTO, BN216.BN216_VL_UNIT, BN216.BN216_QT_UNIT))

HAVING 1=1
	AND	BN216_NR_GRUPO IS NOT NULL

/*
ORDER BY
	 BN216_NR_GRUPO
	,BN216_NR_INST
	,DATA
*/


GO

SELECT * FROM VW_BN216_TT

ORDER BY
	 BN216_NR_GRUPO
	,BN216_NR_INST
	,DATA