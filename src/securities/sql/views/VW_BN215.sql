-- Configura View
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- Apaga view
IF  EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[VW_BN215]'))
DROP VIEW [dbo].[VW_BN215]
GO

-- Relatório Diário de Garantias

-- Cria View
CREATE VIEW [dbo].[VW_BN215]
WITH ENCRYPTION
AS

SELECT
  
	 BN215.BN215_NR_GRUPO
	,BN215.BN215_NR_INST
	,BN004_TP_PROD
--	,BN215.BN215_NR_PROD
	,BN215.BN215_NR_BANCO
	,BN215.BN215_NR_AGENC
	,BN215.BN215_NR_CONTA
	,BN215.BN215_NR_CNPJ
	,SUM(BN215.BN215_TT_CONTRA) AS BN215_TT_CONTRA
	,SUM(BN215.BN215_TT_NOM)	AS BN215_TT_NOM
	,SUM(BN215.BN215_TT_PRES)	AS BN215_TT_PRES
	,SUM(BN215.BN215_TT_EXIG)	AS BN215_TT_EXIG
--	,BN215.BN215_NR_OPESIS
--	,BN215.BN215_DT_INCSIS
--	,BN215.BN215_DT_ATUSIS

	,BN009.BN009_NM_CONTA
	,BN009.BN009_NR_BANCO	
	,BN009.BN009_NR_AGENC
	,BN009.BN009_NR_CONTA

	,(SELECT TOP 1 BN200.BN200_NM_EEMCCB FROM BN200
	  WHERE 1=1
		AND BN200.BN200_NR_GRUPO	= BN215.BN215_NR_GRUPO
		AND BN200.BN200_NR_INST		= BN215.BN215_NR_INST
		AND BN200.BN200_NR_CNPJ		= BN215.BN215_NR_CNPJ
	) AS BN200_NM_EEMCCB

 
FROM BN215 AS BN215

LEFT OUTER JOIN BN009 AS BN009
ON  BN009.BN009_NR_BANCO 	=  BN215.BN215_NR_BANCO
AND BN009.BN009_NR_AGENC 	=  BN215.BN215_NR_AGENC
AND BN009.BN009_NR_CONTA 	=  BN215.BN215_NR_CONTA

INNER JOIN BN004 AS BN004
ON BN004.BN004_NR_PROD = BN215.BN215_NR_PROD

/*
LEFT OUTER JOIN BN200 AS BN200
ON  BN200.BN200_NR_GRUPO	= BN215.BN215_NR_GRUPO
AND BN200.BN200_NR_INST		= BN215.BN215_NR_INST
AND BN200.BN200_NR_CNPJ		= BN215.BN215_NR_CNPJ
*/


--WHERE BN215_NR_GRUPO = 59118133 AND BN004_TP_PROD='C'


GROUP BY 
	 BN215.BN215_NR_GRUPO
	,BN215.BN215_NR_INST
	,BN004_TP_PROD
--	,BN215.BN215_NR_PROD
	,BN215.BN215_NR_BANCO
	,BN215.BN215_NR_AGENC
	,BN215.BN215_NR_CONTA
	,BN215.BN215_NR_CNPJ
--	,BN215.BN215_NR_OPESIS
--	,BN215.BN215_DT_INCSIS
--	,BN215.BN215_DT_ATUSIS

	,BN009.BN009_NM_CONTA
	,BN009.BN009_NR_BANCO	
	,BN009.BN009_NR_AGENC
	,BN009.BN009_NR_CONTA

