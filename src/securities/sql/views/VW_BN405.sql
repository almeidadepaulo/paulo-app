-- Configura View
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- Apaga view
IF  EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[VW_BN405]'))
DROP VIEW [dbo].[VW_BN405]
GO

-- Cria View
CREATE VIEW [dbo].[VW_BN405]
WITH ENCRYPTION
AS
  SELECT 
	BN405.BN405_NR_GRUPO,
	BN405.BN405_NR_INST,
	BN405.BN405_NR_CONTRA,
	BN405.BN405_TP_CPFCNPJ,
	BN405.BN405_NR_CPFCNPJ,
	BN405.BN405_NR_PROD,
	BN405.BN405_NR_LOTE,

	BN150.BN150_NR_CONTA,
	BN150.BN150_NM_CLIENT,
	BN150.BN150_NM_LOGRAD,
	BN150.BN150_NM_BAIRRO,
	BN150.BN150_NM_CIDADE,
	BN150.BN150_SG_UF,
	BN150.BN150_NR_CEP,
	BN150.BN150_DT_NASC,
	BN150.BN150_DT_LIBERA,
	BN150.BN150_VL_FINAM,
	BN150.BN150_VL_RENDA,
	BN150.BN150_QT_PARC,
	BN150.BN150_VL_PARC,
	BN150.BN150_DT_VENCTO,
	BN150.BN150_TX_FINAM,
	BN150.BN150_NR_ERRO,
	BN150.BN150_NR_CCC,
	BN150.BN150_ST_CCC,
	BN150.BN150_NR_OPESIS,
	BN150.BN150_DT_INCSIS,
	BN150.BN150_DT_ATUSIS,
	BN150.BN150_TP_MOVTO,
  
	BN004.BN004_NR_PROD,
	BN004.BN004_NM_PROD,
  
	BN002.BN002_NR_INST,
	BN002.BN002_NM_INST,
  
	VW_BN153_DG.BN153_NR_GRUPO,
	VW_BN153_DG.BN153_NR_INST,
	VW_BN153_DG.BN153_DT_BASE,
	VW_BN153_DG.BN153_NR_PROD,
	VW_BN153_DG.BN153_NR_CONTRA,
	VW_BN153_DG.BN153_DT_PVCTO, 
	VW_BN153_DG.BN153_DT_UVCTO, 
	VW_BN153_DG.BN153_QT_PAREX, 
	VW_BN153_DG.BN153_VL_PARC, 
	VW_BN153_DG.BN153_TT_NOM, 
	VW_BN153_DG.BN153_TT_PRES, 
	VW_BN153_DG.BN153_TT_EXIG,
	VW_BN153_DG.BN153_DT_INCSIS,
	VW_BN153_DG.BN153_NR_LOTE,

	VW_BN153_DG.BN009_NR_BANCO,
	VW_BN153_DG.BN009_NR_AGENC,
	VW_BN153_DG.BN009_NR_CONTA,
	VW_BN153_DG.BN009_NM_CONTA

  
  FROM BN405 AS BN405
  
  INNER JOIN BN001 AS BN001 -- GRUPO
  ON BN001.BN001_NR_GRUPO  = BN405.BN405_NR_GRUPO
    
  INNER JOIN BN002 AS BN002 -- INSTITUIÇÃO
  ON 	BN002.BN002_NR_GRUPO 	= BN405.BN405_NR_GRUPO
  AND	BN002.BN002_NR_INST 	= BN405.BN405_NR_INST 

  INNER JOIN BN004 AS BN004 -- PRODUTO
  ON 	BN004.BN004_NR_PROD = BN405.BN405_NR_PROD

  INNER JOIN BN150 AS BN150 -- LOTE - CONTRATO
  ON  	BN150.BN150_NR_CNPJ  	= BN002.BN002_NR_CNPJ
  AND  	BN150.BN150_TP_MOVTO 	= 'D'
  AND  	BN150.BN150_NR_LOTE  	= BN405.BN405_NR_LOTE
  AND  	BN150.BN150_NR_CONTRA 	= BN405.BN405_NR_CONTRA
  AND  	BN150.BN150_NR_ERRO   	= 0

  INNER JOIN VW_BN153_DG AS VW_BN153_DG
  ON	VW_BN153_DG.BN153_NR_GRUPO  	= BN405.BN405_NR_GRUPO
  AND  	VW_BN153_DG.BN153_NR_INST 	= BN405.BN405_NR_INST
  AND  	VW_BN153_DG.BN153_NR_LOTE  	= BN150.BN150_NR_LOTE
  AND  	VW_BN153_DG.BN153_NR_CONTRA 	= BN150.BN150_NR_CONTRA
  


GO


