-- Configura View
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- Apaga view
IF  EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[VW_BN202]'))
DROP VIEW [dbo].[VW_BN202]
GO

-- Cria View
CREATE VIEW [dbo].[VW_BN202]
WITH ENCRYPTION
AS
  SELECT 
  
	BN202.BN202_NR_GRUPO
	,BN202.BN202_NR_INST
	,BN202.BN202_NR_CNPJ
	,BN202.BN202_NR_CONTRAOR
	,BN202.BN202_DT_VTEPAR
	,BN202.BN202_TP_EPARC
	,BN202.BN202_NR_REME
	,BN202.BN202_NR_LOTE
	,BN202.BN202_NR_PARC
	,BN202.BN202_TX_EVENTO
	,BN202.BN202_VL_TEPARORI
	,BN202.BN202_VL_TEPARATU
	,BN202.BN202_ST_PARCELA
	,BN202.BN202_TP_BAIXA
	,BN202.BN202_VL_OPESIS
	,BN202.BN202_DT_INCSIS
	,BN202.BN202_DT_ATUSIS

	-- Recuperando somente o necessário:
	,VW_BN201.BN200_NM_EEMCCB
	,VW_BN201.BN200_NR_CNPJ
	,VW_BN201.BN017_NR_NM_CNAE

	--,VW_BN201.BN201_NR_GRUPO
	--,VW_BN201.BN201_NR_INST
	--,VW_BN201.BN201_NR_CNPJ
	,VW_BN201.BN201_NR_CONTRAOR
	,VW_BN201.BN201_NR_REME
	--,VW_BN201.BN201_NR_LOTE
	,VW_BN201.BN201_NR_ATIVO
	--,VW_BN201.BN201_TP_ATIVO
	--,VW_BN201.BN201_TP_ORCRED
	--,VW_BN201.BN201_TP_FLXCONTRA
	--,VW_BN201.BN201_DT_ECONTRA
	--,VW_BN201.BN201_DT_VCONTRA
	--,VW_BN201.BN201_VL_TCONTRA
	--,VW_BN201.BN201_VL_CONTRATU
	--,VW_BN201.BN201_QT_TTPARCON
	--,VW_BN201.BN201_QT_PARCEFGC
	--,VW_BN201.BN201_NR_RTIDTXF
	--,VW_BN201.BN201_VL_PRCTXF
	--,VW_BN201.BN201_VL_TXJURANU
	--,VW_BN201.BN201_NR_PROD
	--,VW_BN201.BN201_QT_PRZOPER
	--,VW_BN201.BN201_ST_CALCEX1P
	,VW_BN201.BN201_ST_CONTRATO
	--,VW_BN201.BN201_QT_DEPOS
	--,VW_BN201.BN201_DT_DEVOLU
	--,VW_BN201.BN201_ST_DEVSOL
	--,VW_BN201.BN201_NR_MOTDEV
	--,VW_BN201.BN201_NR_OPESIS
	--,VW_BN201.BN201_DT_INCSIS
	--,VW_BN201.BN201_DT_ATUSIS

	,VW_BN201.BN004_NM_PROD
	,VW_BN201.BN200_ST_CONCNPJ
    
  FROM BN202 AS BN202
  
  INNER JOIN VW_BN201 AS VW_BN201
  ON VW_BN201.BN201_NR_GRUPO		= BN202.BN202_NR_GRUPO
  AND VW_BN201.BN201_NR_INST		= BN202.BN202_NR_INST
  AND VW_BN201.BN201_NR_CNPJ		= BN202.BN202_NR_CNPJ
  AND VW_BN201.BN201_NR_CONTRAOR	= BN202.BN202_NR_CONTRAOR
  AND VW_BN201.BN201_NR_REME		= BN202.BN202_NR_REME
 

 UNION ALL -- CHAMADO 102
 
  SELECT 
  
	BN212.BN212_NR_GRUPO
	,BN212.BN212_NR_INST
	,BN212.BN212_NR_CNPJ
	,BN212.BN212_NR_CONTRAOR
	,BN212.BN212_DT_VTEPAR
	,BN212.BN212_TP_EPARC
	,BN212.BN212_NR_REME
	,BN212.BN212_NR_LOTE
	,BN212.BN212_NR_PARC
	,BN212.BN212_TX_EVENTO
	,BN212.BN212_VL_TEPARORI
	,BN212.BN212_VL_TEPARATU
	,BN212.BN212_ST_PARCELA
	,1 AS BN212_TP_BAIXA
	,BN212.BN212_VL_OPESIS
	,BN212.BN212_DT_INCSIS
	,BN212.BN212_DT_ATUSIS

	-- Recuperando somente o necessário:
	,VW_BN201.BN200_NM_EEMCCB
	,VW_BN201.BN200_NR_CNPJ
	,VW_BN201.BN017_NR_NM_CNAE

	--,VW_BN201.BN201_NR_GRUPO
	--,VW_BN201.BN201_NR_INST
	--,VW_BN201.BN201_NR_CNPJ
	,VW_BN201.BN201_NR_CONTRAOR
	,VW_BN201.BN201_NR_REME
	--,VW_BN201.BN201_NR_LOTE
	,VW_BN201.BN201_NR_ATIVO
	--,VW_BN201.BN201_TP_ATIVO
	--,VW_BN201.BN201_TP_ORCRED
	--,VW_BN201.BN201_TP_FLXCONTRA
	--,VW_BN201.BN201_DT_ECONTRA
	--,VW_BN201.BN201_DT_VCONTRA
	--,VW_BN201.BN201_VL_TCONTRA
	--,VW_BN201.BN201_VL_CONTRATU
	--,VW_BN201.BN201_QT_TTPARCON
	--,VW_BN201.BN201_QT_PARCEFGC
	--,VW_BN201.BN201_NR_RTIDTXF
	--,VW_BN201.BN201_VL_PRCTXF
	--,VW_BN201.BN201_VL_TXJURANU
	--,VW_BN201.BN201_NR_PROD
	--,VW_BN201.BN201_QT_PRZOPER
	--,VW_BN201.BN201_ST_CALCEX1P
	,VW_BN201.BN201_ST_CONTRATO
	--,VW_BN201.BN201_QT_DEPOS
	--,VW_BN201.BN201_DT_DEVOLU
	--,VW_BN201.BN201_ST_DEVSOL
	--,VW_BN201.BN201_NR_MOTDEV
	--,VW_BN201.BN201_NR_OPESIS
	--,VW_BN201.BN201_DT_INCSIS
	--,VW_BN201.BN201_DT_ATUSIS

	,VW_BN201.BN004_NM_PROD
	,VW_BN201.BN200_ST_CONCNPJ
    
  FROM BN212 AS BN212
  
  INNER JOIN VW_BN201 AS VW_BN201
  ON VW_BN201.BN201_NR_GRUPO		= BN212.BN212_NR_GRUPO
  AND VW_BN201.BN201_NR_INST		= BN212.BN212_NR_INST
  AND VW_BN201.BN201_NR_CNPJ		= BN212.BN212_NR_CNPJ
  AND VW_BN201.BN201_NR_CONTRAOR	= BN212.BN212_NR_CONTRAOR
  AND VW_BN201.BN201_NR_REME		= BN212.BN212_NR_REME

  WHERE BN212.BN212_ST_PARCELA = '2' -- Paulo Almeida informou que somente as parcelas com status 2 desta tabela sejam recuperados.

GO


