-- Configura View
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- Apaga view
IF  EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[VW_CB208_FLUXO_MENSAL]'))
DROP VIEW [dbo].[VW_CB208_FLUXO_MENSAL]
GO

-- Carteira - Fluxo Mensal
-- Cria View
CREATE VIEW [dbo].[VW_CB208_FLUXO_MENSAL]
WITH ENCRYPTION
AS
 SELECT 
  CB208_NR_OPERADOR,
  CB208_NR_CEDENTE,
  CB053_DS_EMIEMP,
  FLOOR(CB208_DT_MOVTO/100)							AS CB208_DT_MES_ANO,
  FLOOR(CB208_DT_MOVTO/10000)						AS CB208_DT_ANO,
  SUBSTRING(CONVERT(VARCHAR, CB208_DT_MOVTO),5,2)	AS CB208_DT_MES,
  SUM(CB208_VL_TOTDIA) CB208_VL_TOTDIA,
  SUM(CB208_VL_CATPRO) CB208_VL_CATPRO,
  SUM(CB208_VL_CATCED) CB208_VL_CATCED,  
  SUM(CB208_QT_TOTAL)  CB208_QT_TOTAL  
  
  
FROM CB208

LEFT JOIN CB053
ON  CB053_NR_INST	= CB208_NR_OPERADOR   
AND CB053_CD_EMIEMP = CB208_NR_CEDENTE 

GROUP BY 
  FLOOR(CB208_DT_MOVTO/100),						-- AS CB208_DT_MES_ANO,
  FLOOR(CB208_DT_MOVTO/10000),						-- AS CB208_DT_ANO,
  SUBSTRING(CONVERT(VARCHAR, CB208_DT_MOVTO),5,2),	-- AS CB208_DT_MES,
  CB208_NR_OPERADOR,
  CB208_NR_CEDENTE,
  CB053_DS_EMIEMP

 
GO

