IF EXISTS (SELECT * FROM sysobjects WHERE id = object_id('dbo.SP_CB208_VENCIDO'))
  DROP PROCEDURE dbo.SP_CB208_VENCIDO
GO
CREATE PROCEDURE dbo.SP_CB208_VENCIDO
/*:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
  :: EMPRESA    : Publish                                                      ::
  :: SISTEMA    : Publish cobran�a                                             ::
  :: M�DULO     : Vencidos                                                     ::
  :: UTILIZ. POR: F03SF05J                                                     ::
  :: OBSERVA��O :                                                              ::
  ::---------------------------------------------------------------------------::
  :: PROGRAMADOR: Fabio Bernardo                                               ::
  :: DATA       : 27/05/2014                                   VERS�O SP:      ::
  :: ALTERA��O  : Alterado para dar total por linha                            ::
  ::---------------------------------------------------------------------------::
  :: PROGRAMADOR: Felipe Cesarini                                              ::
  :: DATA       : 09/05/2011                                   VERS�O SP:    1 ::
  :: ALTERA��O  : Primeira vers�o                                              ::
  :::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::*/
  /*-------------------------------------------------------------------------------
  DESCRI��O DA FUNCIONALIDADE:

  Vencidos
  -------------------------------------------------------------------------------*/
  @ENT_NR_VRS    VARCHAR(4)   ,       /* ENTRADA DA VERSAO DO MODULO             */
  @ENT_NR_INST   NUMERIC(5,0) ,       /* Nr. institui��o                         */
  @ENT_CD_EMIEMP NUMERIC(5,0)         /* Nr. emissor/empresa                     */
  WITH ENCRYPTION
AS
/*--------------------------------------------------------------------------*/
/* Verifica se a vers�o do M�dulo � diferente da vers�o da Stored Procedure */
/*--------------------------------------------------------------------------*/
DECLARE @LOC_NR_RTCODE INTEGER
EXECUTE @LOC_NR_RTCODE = SP_CD0100002 @ENT_NR_VRS, '1', 'SP_CB0305019'
IF @LOC_NR_RTCODE = 99999 RETURN 99999
/*--------------------------------------------------------------------------*/
SET QUOTED_IDENTIFIER ON
SET ANSI_NULLS OFF

DECLARE
  @DT_ATUAL NUMERIC(8)

/* BUSCA A DATA ATUAL */
SELECT @DT_ATUAL = CONVERT(NUMERIC, CONVERT(VARCHAR, GETDATE(), 112))

DECLARE 
  @CB208_VL_DIA15    NUMERIC(16,2),
  @CB208_QT_DIA15    NUMERIC(10)  ,
  @CB208_VL_DIA615   NUMERIC(16,2),
  @CB208_QT_DIA615   NUMERIC(10)  ,
  @CB208_VL_DIA1630  NUMERIC(16,2),
  @CB208_QT_DIA1630  NUMERIC(10)  ,
  @CB208_VL_DIA3160  NUMERIC(16,2),
  @CB208_QT_DIA3160  NUMERIC(10)  ,
  @CB208_VL_DIA6190  NUMERIC(16,2),
  @CB208_QT_DIA6190  NUMERIC(10)  ,
  @CB208_VL_DIA91180 NUMERIC(16,2),
  @CB208_QT_DIA91180 NUMERIC(10)  ,
  @CB208_VL_DIA181360 NUMERIC(16,2),
  @CB208_QT_DIA181360 NUMERIC(10)  ,
  @CB208_VL_DIA360   NUMERIC(16,2),
  @CB208_QT_DIA360   NUMERIC(10)   

-- DE 1 A 5 DIAS
SELECT 
  @CB208_VL_DIA15 = SUM(CB208_VL_TOTDIA),
  @CB208_QT_DIA15 = SUM(CB208_QT_TOTAL)
FROM 
  CB208 WITH (NOLOCK) 
WHERE 
    (@ENT_NR_INST   IS NULL OR CB208_NR_OPERADOR   = @ENT_NR_INST)
AND (@ENT_CD_EMIEMP IS NULL OR CB208_NR_CEDENTE = @ENT_CD_EMIEMP)
AND  CB208_DT_MOVTO < @DT_ATUAL
AND  CB208_DT_MOVTO BETWEEN CONVERT(NUMERIC, CONVERT(VARCHAR, DATEADD(DD, -5, CONVERT(DATETIME, CONVERT(CHAR, @DT_ATUAL), 103)), 112)) AND @DT_ATUAL
--AND  CB208_DT_MOVTO BETWEEN @DT_ATUAL -5 AND @DT_ATUAL


---- DE 6 A 15 DIAS
SELECT 
  @CB208_VL_DIA615 = SUM(CB208_VL_TOTDIA),
  @CB208_QT_DIA615 = SUM(CB208_QT_TOTAL)
FROM 
  CB208 WITH (NOLOCK) 
WHERE 
    (@ENT_NR_INST   IS NULL OR CB208_NR_OPERADOR   = @ENT_NR_INST)
AND (@ENT_CD_EMIEMP IS NULL OR CB208_NR_CEDENTE = @ENT_CD_EMIEMP)
AND  CB208_DT_MOVTO < @DT_ATUAL
AND  CB208_DT_MOVTO BETWEEN CONVERT(NUMERIC, CONVERT(VARCHAR, DATEADD(DD, -15, CONVERT(DATETIME, CONVERT(CHAR, @DT_ATUAL), 103)), 112)) AND CONVERT(NUMERIC, CONVERT(VARCHAR, DATEADD(DD, -6, CONVERT(DATETIME, CONVERT(CHAR, @DT_ATUAL), 103)), 112))
--AND  CONVERT(VARCHAR(10), CONVERT(DATETIME, CONVERT(CHAR, CB208_DT_MOVTO )), 103) BETWEEN CONVERT(VARCHAR(10), (GETDATE()-15), 103) AND CONVERT(VARCHAR(10), (GETDATE()-6), 103)
--AND  CB208_DT_MOVTO BETWEEN @DT_ATUAL -15 AND @DT_ATUAL - 6


---- DE 16 A 30 DIAS
SELECT 
  @CB208_VL_DIA1630 = SUM(CB208_VL_TOTDIA),
  @CB208_QT_DIA1630 = SUM(CB208_QT_TOTAL)
FROM 
  CB208 WITH (NOLOCK) 
WHERE 
    (@ENT_NR_INST   IS NULL OR CB208_NR_OPERADOR   = @ENT_NR_INST)
AND (@ENT_CD_EMIEMP IS NULL OR CB208_NR_CEDENTE = @ENT_CD_EMIEMP)
AND  CB208_DT_MOVTO < @DT_ATUAL
AND  CB208_DT_MOVTO BETWEEN CONVERT(NUMERIC, CONVERT(VARCHAR, DATEADD(DD, -30, CONVERT(DATETIME, CONVERT(CHAR, @DT_ATUAL), 103)), 112)) AND CONVERT(NUMERIC, CONVERT(VARCHAR, DATEADD(DD, -16, CONVERT(DATETIME, CONVERT(CHAR, @DT_ATUAL), 103)), 112))
--AND  CONVERT(VARCHAR(10), CONVERT(DATETIME, CONVERT(CHAR, CB208_DT_MOVTO )), 103) BETWEEN CONVERT(VARCHAR(10), (GETDATE()-30), 103) AND CONVERT(VARCHAR(10), (GETDATE()-16), 103)
--AND  CB208_DT_MOVTO BETWEEN @DT_ATUAL -30 AND @DT_ATUAL - 16

---- DE 31 A 60 DIAS
SELECT 
  @CB208_VL_DIA3160 = SUM(CB208_VL_TOTDIA),
  @CB208_QT_DIA3160 = SUM(CB208_QT_TOTAL)
FROM 
  CB208 WITH (NOLOCK) 
WHERE 
    (@ENT_NR_INST   IS NULL OR CB208_NR_OPERADOR   = @ENT_NR_INST)
AND (@ENT_CD_EMIEMP IS NULL OR CB208_NR_CEDENTE = @ENT_CD_EMIEMP)
AND  CB208_DT_MOVTO < @DT_ATUAL
AND  CB208_DT_MOVTO BETWEEN CONVERT(NUMERIC, CONVERT(VARCHAR, DATEADD(DD, -60, CONVERT(DATETIME, CONVERT(CHAR, @DT_ATUAL), 103)), 112)) AND CONVERT(NUMERIC, CONVERT(VARCHAR, DATEADD(DD, -31, CONVERT(DATETIME, CONVERT(CHAR, @DT_ATUAL), 103)), 112))
--AND  CONVERT(VARCHAR(10), CONVERT(DATETIME, CONVERT(CHAR, CB208_DT_MOVTO )), 103) BETWEEN CONVERT(VARCHAR(10), (GETDATE()-60), 103) AND CONVERT(VARCHAR(10), (GETDATE()-31), 103)
--AND  CB208_DT_MOVTO BETWEEN @DT_ATUAL -60 AND @DT_ATUAL - 31

---- DE 61 A 90 DIAS
SELECT 
  @CB208_VL_DIA6190 = SUM(CB208_VL_TOTDIA),
  @CB208_QT_DIA6190 = SUM(CB208_QT_TOTAL)
FROM 
  CB208 WITH (NOLOCK) 
WHERE 
    (@ENT_NR_INST   IS NULL OR CB208_NR_OPERADOR   = @ENT_NR_INST)
AND (@ENT_CD_EMIEMP IS NULL OR CB208_NR_CEDENTE = @ENT_CD_EMIEMP)
AND  CB208_DT_MOVTO < @DT_ATUAL
AND  CB208_DT_MOVTO BETWEEN CONVERT(NUMERIC, CONVERT(VARCHAR, DATEADD(DD, -90, CONVERT(DATETIME, CONVERT(CHAR, @DT_ATUAL), 103)), 112)) AND CONVERT(NUMERIC, CONVERT(VARCHAR, DATEADD(DD, -61, CONVERT(DATETIME, CONVERT(CHAR, @DT_ATUAL), 103)), 112))
--AND  CONVERT(VARCHAR(10), CONVERT(DATETIME, CONVERT(CHAR, CB208_DT_MOVTO )), 103) BETWEEN CONVERT(VARCHAR(10), (GETDATE()-90), 103) AND CONVERT(VARCHAR(10), (GETDATE()-61), 103)
--AND  CB208_DT_MOVTO BETWEEN @DT_ATUAL -90 AND @DT_ATUAL - 61

---- DE 91 A 180 DIAS
SELECT 
  @CB208_VL_DIA91180 = SUM(CB208_VL_TOTDIA),
  @CB208_QT_DIA91180 = SUM(CB208_QT_TOTAL)
FROM 
  CB208 WITH (NOLOCK) 
WHERE 
    (@ENT_NR_INST   IS NULL OR CB208_NR_OPERADOR   = @ENT_NR_INST)
AND (@ENT_CD_EMIEMP IS NULL OR CB208_NR_CEDENTE = @ENT_CD_EMIEMP)
AND  CB208_DT_MOVTO < @DT_ATUAL
AND  CB208_DT_MOVTO BETWEEN CONVERT(NUMERIC, CONVERT(VARCHAR, DATEADD(DD, -180, CONVERT(DATETIME, CONVERT(CHAR, @DT_ATUAL), 103)), 112)) AND CONVERT(NUMERIC, CONVERT(VARCHAR, DATEADD(DD, -91, CONVERT(DATETIME, CONVERT(CHAR, @DT_ATUAL), 103)), 112))

---- DE 181 A 360 DIAS
SELECT 
  @CB208_VL_DIA181360 = SUM(CB208_VL_TOTDIA),
  @CB208_QT_DIA181360 = SUM(CB208_QT_TOTAL)
FROM 
  CB208 WITH (NOLOCK) 
WHERE 
    (@ENT_NR_INST   IS NULL OR CB208_NR_OPERADOR   = @ENT_NR_INST)
AND (@ENT_CD_EMIEMP IS NULL OR CB208_NR_CEDENTE = @ENT_CD_EMIEMP)
AND  CB208_DT_MOVTO < @DT_ATUAL
AND  CB208_DT_MOVTO BETWEEN CONVERT(NUMERIC, CONVERT(VARCHAR, DATEADD(DD, -360, CONVERT(DATETIME, CONVERT(CHAR, @DT_ATUAL), 103)), 112)) AND CONVERT(NUMERIC, CONVERT(VARCHAR, DATEADD(DD, -181, CONVERT(DATETIME, CONVERT(CHAR, @DT_ATUAL), 103)), 112))

---- DE >= 360 DIAS
SELECT 
  @CB208_VL_DIA360 = SUM(CB208_VL_TOTDIA),
  @CB208_QT_DIA360 = SUM(CB208_QT_TOTAL)
FROM 
  CB208 WITH (NOLOCK) 
WHERE 
    (@ENT_NR_INST   IS NULL OR CB208_NR_OPERADOR   = @ENT_NR_INST)
AND (@ENT_CD_EMIEMP IS NULL OR CB208_NR_CEDENTE = @ENT_CD_EMIEMP)
AND  CB208_DT_MOVTO < @DT_ATUAL
AND  CB208_DT_MOVTO <= CONVERT(NUMERIC, CONVERT(VARCHAR, DATEADD(DD, -360, CONVERT(DATETIME, CONVERT(CHAR, @DT_ATUAL), 103)), 112))

--RESULT SET
SELECT
  1 AS ORDEM
  ,'1 A 5 DIAS' AS POSICAO
  ,ISNULL(@CB208_VL_DIA15, 0)   CB208_VL_TOTDIA	--CB208_VL_DIA15  , 
  ,ISNULL(@CB208_QT_DIA15, 0)   CB208_QT_TOTAL	--CB208_QT_DIA15  
UNION  
SELECT
  2 AS ORDEM
  ,'6 A 15 DIAS' AS POSICAO 
  ,ISNULL(@CB208_VL_DIA615, 0)  CB208_VL_TOTDIA	--CB208_VL_DIA615 , 
  ,ISNULL(@CB208_QT_DIA615, 0)  CB208_QT_TOTAL	--CB208_QT_DIA615 
UNION  
SELECT
  3 AS ORDEM
  ,'16 A 30 DIAS' AS POSICAO
  ,ISNULL(@CB208_VL_DIA1630, 0) CB208_VL_TOTDIA	--CB208_VL_DIA1630,
  ,ISNULL(@CB208_QT_DIA1630, 0) CB208_QT_TOTAL	--CB208_QT_DIA1630
UNION  
SELECT
  4 AS ORDEM
  ,'31 A 60 DIAS' AS POSICAO
  ,ISNULL(@CB208_VL_DIA3160, 0) CB208_VL_TOTDIA	--CB208_VL_DIA3160,
  ,ISNULL(@CB208_QT_DIA3160, 0) CB208_QT_TOTAL	--CB208_QT_DIA3160
UNION  
SELECT
  5 AS ORDEM
  ,'61 A 90 DIAS' AS POSICAO
  ,ISNULL(@CB208_VL_DIA6190, 0) CB208_VL_TOTDIA	--CB208_VL_DIA6190,
  ,ISNULL(@CB208_QT_DIA6190, 0) CB208_QT_TOTAL	--CB208_QT_DIA6190,
UNION  
SELECT
  6 AS ORDEM
  ,'91 A 180 DIAS' AS POSICAO
  ,ISNULL(@CB208_VL_DIA91180, 0)   CB208_VL_TOTDIA--CB208_VL_DIA360  ,
  ,ISNULL(@CB208_QT_DIA91180, 0)   CB208_QT_TOTAL	--CB208_VL_DIA360 
UNION  
SELECT
  7 AS ORDEM
  ,'181 A 360 DIAS' AS POSICAO
  ,ISNULL(@CB208_VL_DIA181360, 0)   CB208_VL_TOTDIA--CB208_VL_DIA360  ,
  ,ISNULL(@CB208_QT_DIA181360, 0)   CB208_QT_TOTAL	--CB208_VL_DIA360 
UNION  
SELECT
  8 AS ORDEM
  ,'ACIMA DE 360 DIAS' AS POSICAO
  ,ISNULL(@CB208_VL_DIA360, 0)   CB208_VL_TOTDIA--CB208_VL_DIA360  ,
  ,ISNULL(@CB208_QT_DIA360, 0)   CB208_QT_TOTAL	--CB208_VL_DIA360 


SET QUOTED_IDENTIFIER OFF
SET ANSI_NULLS ON
/*-------------------------------------------------------------------------------
  RESULT SET:
  

  CB208_VL_TOTDIA,
  CB208_VL_CATPRO,
  CB208_VL_CATCED 
-------------------------------------------------------------------------------*/
GO