-- Configura View
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- Apaga view
IF  EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[VW_CB003_DIST_MENSAL_REGIAO]'))
DROP VIEW [dbo].[VW_CB003_DIST_MENSAL_REGIAO]
GO

-- PUBLISH - Publicações -  Distribuição por região mensal

-- Cria View
CREATE VIEW [dbo].[VW_CB003_DIST_MENSAL_REGIAO]
WITH ENCRYPTION
AS


SELECT
  CB003_NR_INST,
  CB003_CD_EMIEMP,
  CB053_DS_EMIEMP,
  CB003_CD_PUBLIC,
  CB060_DS_PUBLIC,
  CB003_CD_REGIAO,
  CB070_DS_REGIAO,
  FLOOR(CB003_DT_MOVTO/100)						AS CB003_DT_MES_ANO,
  FLOOR(CB003_DT_MOVTO/10000)						AS CB003_DT_ANO,
  SUBSTRING(CONVERT(VARCHAR, CB003_DT_MOVTO),5,2)	AS CB003_DT_MES,
  FLOOR(CB003_DT_MOVTO / 100) CB003_DT_MOVTO,
  SUM(CB003_TT_OBJETO) CB003_TT_OBJETO,
  SUM(CB003_TT_CONTRA) CB003_TT_CONTRA,
  SUM(CB003_TT_CUSPUB)  CB003_TT_CUSPUB,
  SUM(CB003_TT_CUSCAP) CB003_TT_CUSCAP,
  SUM(CB003_TT_CUSINS)  CB003_TT_CUSINS ,
  SUM(CB003_TT_CUSPOS) CB003_TT_CUSPOS,
  SUM((CB003_TT_CUSPUB) + (CB003_TT_CUSCAP) + (CB003_TT_CUSINS) + (CB003_TT_CUSPOS)) CB003_VL_TOT
FROM
  CB003,
  CB060,
  CB053,
  CB070
WHERE	1=1

/*    (@ENT_NR_INST   IS NULL OR CB003_NR_INST   = @ENT_NR_INST)
AND (@ENT_CD_EMIEMP IS NULL OR CB003_CD_EMIEMP = @ENT_CD_EMIEMP)
AND (@ENT_DT_MES  IS NULL OR FLOOR(CB003_DT_MOVTO / 100) = @ENT_DT_MES) */

/* CB003 -> CB060 */
AND CB003_NR_INST   = CB060_NR_INST
AND CB003_CD_EMIEMP = CB060_CD_EMIEMP
AND CB003_CD_PUBLIC = CB060_CD_PUBLIC
/* CB003 -> CB053 */
AND CB003_NR_INST   = CB053_NR_INST
AND CB003_CD_EMIEMP = CB053_CD_EMIEMP
/* CB003 -> CB070 */
AND CB003_NR_INST   = CB070_NR_INST
AND CB003_CD_REGIAO = CB070_CD_REGIAO
GROUP BY 
  CB003_NR_INST,
  CB003_CD_EMIEMP,
  CB053_DS_EMIEMP,
  CB003_CD_PUBLIC,
  CB060_DS_PUBLIC,
  CB003_CD_REGIAO,
  CB070_DS_REGIAO,  
  FLOOR(CB003_DT_MOVTO/100),							-- AS CB003_DT_MES_ANO,
  FLOOR(CB003_DT_MOVTO/10000),							-- AS CB003_DT_ANO,
  SUBSTRING(CONVERT(VARCHAR, CB003_DT_MOVTO),5,2)		-- AS CB003_DT_MES,
/*
ORDER BY
  CB003_DT_MOVTO ,
  CB003_CD_PUBLIC,
  CB003_CD_REGIAO
*/

GO