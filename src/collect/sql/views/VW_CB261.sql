-- Configura View
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- Apaga view
IF  EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[VW_CB261]'))
DROP VIEW [dbo].[VW_CB261]
GO

-- Cria View
CREATE VIEW [dbo].[VW_CB261]
WITH ENCRYPTION
AS
 SELECT 
  CB261_NR_OPERADOR,
  CB261_NR_CEDENTE,
  CB261_CD_COMPSC,
  CB261_NR_AGENC,
  CB261_NR_CONTA,
  CB261_CD_PUBLIC,
  CB261_CD_MSG,
  CB261_ID_STATUS,
  CASE 
    WHEN CB261_CD_PUBLIC = 1 THEN EM055_DS_CODEMAIL
    WHEN CB261_CD_PUBLIC = 2 THEN MG055_DS_CODSMS
    WHEN CB261_CD_PUBLIC = 3 THEN CR055_DS_CODCOR
    ELSE ''
  END CB261_NM_MSG,
  CB261_NM_REGRA,
  CB261_TP_OPERADOR,
  CB261_NR_DIAS,
  CASE 
    WHEN CB261_TP_ACAO = 1 THEN 'inicial'
    WHEN CB261_TP_ACAO = 2 THEN 'final'
    WHEN CB261_TP_ACAO = 3 THEN Cast(CB261_NR_DIAS as varchar) + ' dia(s) a vencer'
    WHEN CB261_TP_ACAO = 4 THEN Cast(CB261_NR_DIAS as varchar) + ' dia(s) vencido(s)'
    ELSE ''
  END CB261_NM_ACAO,
  CB261_TP_ACAO,
  CB261_ID_ANEXO,
  CB261_CD_OPESIS,
  CB261_DT_INCSIS,
  CB261_DT_ATUSIS,
  
  CB060_DS_PUBLIC,
  MG055_DS_CODSMS,
  EM055_DS_CODEMAIL,
  CR055_CD_CODCOR
  
  FROM CB261
  
  INNER JOIN CB060 AS CB060
  ON CB060_CD_PUBLIC   = CB261_CD_PUBLIC -- Paulo Almeida: Código de publicação não utilizado, manter somente o default para todos
  /*
  ON  CB060_NR_OPERADOR = CB261_NR_OPERADOR
  AND CB060_NR_CEDENTE  = CB261_NR_CEDENTE
  AND CB060_CD_PUBLIC   = CB261_CD_PUBLIC
  */

  LEFT OUTER JOIN MG055
  ON  MG055_NR_INST   = CB261_NR_OPERADOR
  AND MG055_CD_EMIEMP = CB261_NR_CEDENTE
  AND MG055_CD_CODSMS = CB261_CD_MSG

  LEFT OUTER JOIN EM055
  ON  EM055_NR_INST     = CB261_NR_OPERADOR
  AND EM055_CD_EMIEMP   = CB261_NR_CEDENTE
  AND EM055_CD_CODEMAIL = CB261_CD_MSG

  LEFT OUTER JOIN CR055
  ON  CR055_NR_INST   = CB261_NR_OPERADOR
  AND CR055_CD_EMIEMP = CB261_NR_CEDENTE
  AND CR055_CD_CODCOR = CB261_CD_MSG

GO