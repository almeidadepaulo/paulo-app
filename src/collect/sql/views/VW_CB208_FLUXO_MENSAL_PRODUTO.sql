-- Configura View
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- Apaga view
IF  EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[VW_CB208_FLUXO_MENSAL_PRODUTO]'))
DROP VIEW [dbo].[VW_CB208_FLUXO_MENSAL_PRODUTO]
GO

-- Carteira - Fluxo Mensal por Produto
-- Cria View
CREATE VIEW [dbo].[VW_CB208_FLUXO_MENSAL_PRODUTO]
WITH ENCRYPTION
AS
 SELECT 
	CB208_NR_OPERADOR,
	CB208_NR_CEDENTE,
	CB053_DS_EMIEMP,
	CB208_NR_PRODUT,

	FLOOR(CB208_DT_MOVTO/100)						AS CB208_DT_MES_ANO,
	FLOOR(CB208_DT_MOVTO/10000)						AS CB208_DT_ANO,
	SUBSTRING(CONVERT(VARCHAR, CB208_DT_MOVTO),5,2)	AS CB208_DT_MES,
	SUM(CB208_VL_TOTDIA) CB208_VL_TOTDIA,
	SUM(CB208_VL_CATPRO) CB208_VL_CATPRO,
	SUM(CB208_VL_CATCED) CB208_VL_CATCED,  
	SUM(CB208_QT_TOTAL)  CB208_QT_TOTAL,  
	
	-- BANCO
	CB250_CD_COMPSC,
	CB250_NM_BANCO,

	-- PRODUTO
	CB255_CD_PROD,
	CB255_DS_PROD,

	-- CARTEIRA
	CB256_CD_CART,
	CB256_DS_CART
  
  
FROM CB208
LEFT JOIN CB053 -- EMISSOR/EMPRESA
ON  CB053_NR_INST	= CB208_NR_OPERADOR   
AND CB053_CD_EMIEMP = CB208_NR_CEDENTE 

LEFT OUTER JOIN CB250 AS CB250  -- BANCO
ON     CB250_NR_OPERADOR = CB208_NR_OPERADOR
   AND CB250_NR_CEDENTE  = CB208_NR_CEDENTE
   AND CB250_CD_COMPSC	 = CB208_CD_COMPSC 
  

 LEFT JOIN CB256 AS CB256  -- CARTEIRA
 ON     CB256_NR_OPERADOR = CB208_NR_OPERADOR
    AND CB256_NR_CEDENTE  = CB208_NR_CEDENTE
    AND CB256_CD_CART     = CB208_CD_CART 

 LEFT JOIN CB255 AS CB255  -- PRODUTO
 ON     CB255_NR_OPERADOR = CB208_NR_OPERADOR
    AND CB255_NR_CEDENTE  = CB208_NR_CEDENTE
    AND CB255_CD_PROD     = CB208_NR_PRODUT 

GROUP BY 
	CB208_NR_OPERADOR,
	CB208_NR_CEDENTE,
	CB053_DS_EMIEMP,
	CB208_NR_PRODUT,
	CB250_CD_COMPSC,
	CB250_NM_BANCO,
	CB255_CD_PROD,
	CB255_DS_PROD,
	CB256_CD_CART,
	CB256_DS_CART,
	FLOOR(CB208_DT_MOVTO/100),							-- AS CB208_DT_MES_ANO,
	FLOOR(CB208_DT_MOVTO/10000),						-- AS CB208_DT_ANO,
	SUBSTRING(CONVERT(VARCHAR, CB208_DT_MOVTO),5,2)		-- AS CB208_DT_MES,

 
GO

