 -- Configura View
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- Apaga view
IF  EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[VW_EM003]'))
DROP VIEW [dbo].VW_EM003
GO

-- Criar View da tela - EMAIL - Resumo de msg
CREATE VIEW [dbo].VW_EM003
WITH ENCRYPTION
AS

SELECT
  EM003_NR_INST  ,
  CB050_NM_INST  ,
  EM003_CD_EMIEMP,
  CB053_DS_EMIEMP,
  EM003_NR_BROKER,
  EM050_NM_BROKER,
  EM003_DT_MOVTO ,
  SUM(EM003_TT_MENSO) EM003_TT_MENSO,
  SUM(EM003_TT_MENSN) EM003_TT_MENSN,
  (SUM(EM003_TT_MENSO) + SUM(EM003_TT_MENSN)) EM003_TT_MENS,
  (SUM(EM003_TT_MENSO) + SUM(EM003_TT_MENSN)) * SUM(EM051_VL_CUSTO) EM003_VL_VALOR
FROM
  EM003,
  CB050,
  CB053,
  EM050,
  EM051
WHERE
/* EM003 -> EM050 */
    EM003_NR_INST   = CB050_NR_INST
/* EM003 -> EM053 */
AND EM003_NR_INST   = CB053_NR_INST
AND EM003_CD_EMIEMP = CB053_CD_EMIEMP
/* EM003 -> EM050 */
AND EM003_NR_INST   = EM050_NR_INST
AND EM003_NR_BROKER = EM050_NR_BROKER
/* EM003 -> EM051 */
AND EM003_NR_INST   = EM051_NR_INST
AND EM003_NR_BROKER = EM051_NR_BROKER
AND EM051_ID_ATIVO  = 1 /* ATIVO */
GROUP BY 
  EM003_NR_INST  ,
  CB050_NM_INST  ,
  EM003_CD_EMIEMP,
  CB053_DS_EMIEMP,
  EM003_NR_BROKER,
  EM050_NM_BROKER,
  EM003_DT_MOVTO 

GO