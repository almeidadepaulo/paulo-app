 -- Configura View
SET ANSI_NULLS ON
SET QUOTED_IDENTIFIER ON
GO

-- Apaga view
IF  EXISTS (SELECT * FROM sys.views WHERE object_id = OBJECT_ID(N'[dbo].[VW_EM004]'))
DROP VIEW [dbo].VW_EM004
GO

-- Criar View da tela - EMAIL - Resumo de msg por CPF
CREATE VIEW [dbo].VW_EM004
WITH ENCRYPTION
AS

SELECT
  EM004_NR_INST  ,
  CB050_NM_INST  ,
  EM004_CD_EMIEMP,
  CB053_DS_EMIEMP,
  EM004_NR_BROKER,
  EM050_NM_BROKER,
  EM004_NR_CPF   ,
  EM004_DT_MOVTO ,
  SUM(EM004_TT_MENSO) EM004_TT_MENSO,
  SUM(EM004_TT_MENSN) EM004_TT_MENSN,
  (SUM(EM004_TT_MENSO) + SUM(EM004_TT_MENSN)) EM004_TT_MENS
FROM
  EM004,
  CB050,
  CB053,
  EM050
WHERE
/* EM004 -> EM050 */
    EM004_NR_INST   = CB050_NR_INST
/* EM004 -> EM053 */
AND EM004_NR_INST   = CB053_NR_INST
AND EM004_CD_EMIEMP = CB053_CD_EMIEMP
/* EM004 -> EM050 */
AND EM004_NR_INST   = EM050_NR_INST
AND EM004_NR_BROKER = EM050_NR_BROKER
GROUP BY 
  EM004_NR_INST  ,
  CB050_NM_INST  ,
  EM004_CD_EMIEMP,
  CB053_DS_EMIEMP,
  EM004_NR_BROKER,
  EM050_NM_BROKER,
  EM004_NR_CPF   ,
  EM004_DT_MOVTO 
GO